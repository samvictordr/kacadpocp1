<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .sidebar-item { transition: all 0.2s; }
        .sidebar-item:hover { background: rgba(255,255,255,0.1); }
        .sidebar-item.active { background: rgba(255,255,255,0.2); border-left: 3px solid #f59e0b; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-primary { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .btn-primary:hover { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .toast { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .health-dot { width: 12px; height: 12px; border-radius: 50%; }
        .health-healthy { background: #22c55e; }
        .health-unhealthy { background: #ef4444; }
        .health-unknown { background: #9ca3af; }
        .tab-btn.active { border-bottom: 2px solid #f59e0b; color: #f59e0b; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #f59e0b; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input, select, textarea { border: 1px solid #d1d5db; border-radius: 8px; padding: 8px 12px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #374151; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        tr:hover { background: #f9fafb; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-amber-500 to-orange-600">
        <div class="card p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <div class="text-4xl mb-2">üéì</div>
                <h1 class="text-2xl font-bold text-gray-800">Academy Admin</h1>
                <p class="text-gray-500">Sign in to continue</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="loginEmail" class="w-full" placeholder="admin@academy.edu" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="loginPassword" class="w-full" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div id="loginError" class="text-red-500 text-sm hidden"></div>
                <button type="submit" class="w-full btn-primary text-white py-3 rounded-lg font-medium">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden">
        <!-- Sidebar -->
        <div class="fixed left-0 top-0 h-full w-64 bg-gradient-to-b from-gray-900 to-gray-800 text-white z-50">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <div class="text-3xl">üéì</div>
                    <div>
                        <h1 class="font-bold text-lg">Academy Admin</h1>
                        <p class="text-xs text-gray-400" id="adminName">Administrator</p>
                    </div>
                </div>
            </div>
            <nav class="p-4 space-y-1">
                <div class="sidebar-item active rounded-lg px-4 py-3 cursor-pointer flex items-center gap-3" data-page="dashboard">
                    <span>üè†</span> Dashboard
                </div>
                <div class="sidebar-item rounded-lg px-4 py-3 cursor-pointer flex items-center gap-3" data-page="users">
                    <span>üë•</span> User Management
                </div>
                <div class="sidebar-item rounded-lg px-4 py-3 cursor-pointer flex items-center gap-3" data-page="bulk">
                    <span>üì§</span> Bulk Upload
                </div>
                <div class="sidebar-item rounded-lg px-4 py-3 cursor-pointer flex items-center gap-3" data-page="allowances">
                    <span>üí∞</span> Allowances
                </div>
                <div class="sidebar-item rounded-lg px-4 py-3 cursor-pointer flex items-center gap-3" data-page="programs">
                    <span>üè¢</span> Programs
                </div>
                <div class="sidebar-item rounded-lg px-4 py-3 cursor-pointer flex items-center gap-3" data-page="telemetry">
                    <span>üìä</span> Telemetry
                </div>
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-700">
                <button id="logoutBtn" class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-lg flex items-center justify-center gap-2">
                    <span>üö™</span> Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="ml-64 min-h-screen">
            <!-- Header -->
            <header class="bg-white shadow-sm px-8 py-4 flex items-center justify-between">
                <h2 id="pageTitle" class="text-xl font-semibold text-gray-800">Dashboard</h2>
                <div class="flex items-center gap-4">
                    <div id="healthIndicator" class="flex items-center gap-2 text-sm">
                        <div class="health-dot health-unknown"></div>
                        <span>Checking...</span>
                    </div>
                    <button onclick="location.reload()" class="text-gray-500 hover:text-gray-700">üîÑ</button>
                </div>
            </header>

            <!-- Page Content -->
            <main class="p-8">
                <!-- Dashboard Page -->
                <div id="page-dashboard" class="page-content">
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-4 gap-6 mb-8">
                        <div class="stat-card text-white p-6 rounded-xl">
                            <div class="text-3xl font-bold" id="statStudents">-</div>
                            <div class="text-sm opacity-80">Total Students</div>
                        </div>
                        <div class="stat-card text-white p-6 rounded-xl">
                            <div class="text-3xl font-bold" id="statTeachers">-</div>
                            <div class="text-sm opacity-80">Total Teachers</div>
                        </div>
                        <div class="stat-card text-white p-6 rounded-xl">
                            <div class="text-3xl font-bold" id="statTransactions">-</div>
                            <div class="text-sm opacity-80">Transactions Today</div>
                        </div>
                        <div class="stat-card text-white p-6 rounded-xl">
                            <div class="text-3xl font-bold" id="statAttendance">-</div>
                            <div class="text-sm opacity-80">Attendance Today</div>
                        </div>
                    </div>

                    <!-- Service Health -->
                    <div class="card p-6 mb-8">
                        <h3 class="text-lg font-semibold mb-4">Service Health</h3>
                        <div class="grid grid-cols-3 gap-4" id="serviceHealth">
                            <div class="border rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="health-dot health-unknown" id="pgHealth"></div>
                                    <span class="font-medium">PostgreSQL</span>
                                </div>
                                <div class="text-sm text-gray-500" id="pgStatus">Checking...</div>
                            </div>
                            <div class="border rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="health-dot health-unknown" id="mongoHealth"></div>
                                    <span class="font-medium">MongoDB</span>
                                </div>
                                <div class="text-sm text-gray-500" id="mongoStatus">Checking...</div>
                            </div>
                            <div class="border rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="health-dot health-unknown" id="redisHealth"></div>
                                    <span class="font-medium">Redis</span>
                                </div>
                                <div class="text-sm text-gray-500" id="redisStatus">Checking...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Transaction Trend (7 Days)</h3>
                            <canvas id="transactionChart" height="200"></canvas>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Attendance Trend (7 Days)</h3>
                            <canvas id="attendanceChart" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Users Page -->
                <div id="page-users" class="page-content hidden">
                    <div class="flex gap-4 mb-6">
                        <button class="tab-btn active px-4 py-2 font-medium" data-tab="students">Students</button>
                        <button class="tab-btn px-4 py-2 font-medium text-gray-500" data-tab="teachers">Teachers</button>
                        <button class="tab-btn px-4 py-2 font-medium text-gray-500" data-tab="create">Create User</button>
                    </div>
                    
                    <div id="tab-students" class="tab-content">
                        <div class="card">
                            <div class="p-4 border-b flex justify-between items-center">
                                <input type="text" id="searchStudents" placeholder="Search students..." class="w-64">
                                <button onclick="loadStudents()" class="btn-primary text-white px-4 py-2 rounded-lg">Refresh</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table>
                                    <thead><tr><th>Name</th><th>National ID</th><th>Program</th><th>Status</th><th>Actions</th></tr></thead>
                                    <tbody id="studentsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-teachers" class="tab-content hidden">
                        <div class="card">
                            <div class="p-4 border-b flex justify-between items-center">
                                <input type="text" id="searchTeachers" placeholder="Search teachers..." class="w-64">
                                <button onclick="loadTeachers()" class="btn-primary text-white px-4 py-2 rounded-lg">Refresh</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table>
                                    <thead><tr><th>Name</th><th>Employee ID</th><th>Program</th><th>Status</th><th>Actions</th></tr></thead>
                                    <tbody id="teachersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-create" class="tab-content hidden">
                        <div class="card p-6 max-w-2xl">
                            <h3 class="text-lg font-semibold mb-4">Create New User</h3>
                            <form id="createUserForm" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Full Name *</label>
                                        <input type="text" name="full_name" required class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Email *</label>
                                        <input type="email" name="email" required class="w-full">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Role *</label>
                                        <select name="role" required class="w-full" onchange="toggleUserFields(this.value)">
                                            <option value="student">Student</option>
                                            <option value="teacher">Teacher</option>
                                            <option value="store">Store Staff</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Program</label>
                                        <select name="program_id" class="w-full" id="createUserProgram"></select>
                                    </div>
                                </div>
                                <div id="studentFields">
                                    <label class="block text-sm font-medium mb-1">National ID</label>
                                    <input type="text" name="national_id" class="w-full">
                                </div>
                                <div id="teacherFields" class="hidden">
                                    <label class="block text-sm font-medium mb-1">Employee ID</label>
                                    <input type="text" name="employee_id" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Password</label>
                                    <input type="password" name="password" class="w-full" placeholder="Leave blank for temp123">
                                </div>
                                <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Create User</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Bulk Upload Page -->
                <div id="page-bulk" class="page-content hidden">
                    <div class="grid grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">üì§ Bulk Upload Students</h3>
                            <form id="bulkStudentForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Program *</label>
                                    <select name="program_id" required class="w-full" id="bulkStudentProgram"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">CSV File *</label>
                                    <input type="file" name="file" accept=".csv" required class="w-full">
                                </div>
                                <div class="text-sm text-gray-500">
                                    Required columns: <code>full_name, email, phone_number</code>
                                </div>
                                <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Upload Students</button>
                            </form>
                            <div id="bulkStudentResult" class="mt-4"></div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">üì§ Bulk Upload Teachers</h3>
                            <form id="bulkTeacherForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Program *</label>
                                    <select name="program_id" required class="w-full" id="bulkTeacherProgram"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">CSV File *</label>
                                    <input type="file" name="file" accept=".csv" required class="w-full">
                                </div>
                                <div class="text-sm text-gray-500">
                                    Required columns: <code>full_name, email, employee_id</code>
                                </div>
                                <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Upload Teachers</button>
                            </form>
                            <div id="bulkTeacherResult" class="mt-4"></div>
                        </div>
                    </div>
                    
                    <div class="card p-6 mt-6">
                        <h3 class="text-lg font-semibold mb-4">üìã CSV Format Reference</h3>
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-medium mb-2">Student CSV Template</h4>
                                <pre class="bg-gray-100 p-3 rounded text-sm overflow-x-auto">full_name,email,phone_number
Ahmed Mohammed,ahmed@academy.edu,+966501234567
Sara Abdullah,sara@academy.edu,+966501234568</pre>
                            </div>
                            <div>
                                <h4 class="font-medium mb-2">Teacher CSV Template</h4>
                                <pre class="bg-gray-100 p-3 rounded text-sm overflow-x-auto">full_name,email,employee_id
Dr. Khalid Ibrahim,khalid@academy.edu,EMP-001
Dr. Fatima Al-Saud,fatima@academy.edu,EMP-002</pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Allowances Page -->
                <div id="page-allowances" class="page-content hidden">
                    <div class="flex gap-4 mb-6">
                        <button class="tab-btn active px-4 py-2 font-medium" data-tab="viewAllowances">View Allowances</button>
                        <button class="tab-btn px-4 py-2 font-medium text-gray-500" data-tab="setAllowance">Set Individual</button>
                        <button class="tab-btn px-4 py-2 font-medium text-gray-500" data-tab="bulkAllowance">Bulk Set</button>
                    </div>
                    
                    <div id="tab-viewAllowances" class="tab-content">
                        <div class="card">
                            <div class="p-4 border-b flex items-center gap-4">
                                <label class="font-medium">Filter Date:</label>
                                <input type="date" id="allowanceDate" class="w-48">
                                <button onclick="loadAllowances()" class="btn-primary text-white px-4 py-2 rounded-lg">Load</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table>
                                    <thead><tr><th>Student</th><th>Date</th><th>Base</th><th>Bonus</th><th>Total</th></tr></thead>
                                    <tbody id="allowancesTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-setAllowance" class="tab-content hidden">
                        <div class="card p-6 max-w-lg">
                            <h3 class="text-lg font-semibold mb-4">Set Individual Allowance</h3>
                            <form id="setAllowanceForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Student *</label>
                                    <select name="student_id" required class="w-full" id="allowanceStudent"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Date *</label>
                                    <input type="date" name="date" required class="w-full">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Base Amount (SAR)</label>
                                        <input type="number" name="base_amount" value="50" step="0.01" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Bonus (SAR)</label>
                                        <input type="number" name="bonus_amount" value="0" step="0.01" class="w-full">
                                    </div>
                                </div>
                                <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Set Allowance</button>
                            </form>
                        </div>
                    </div>
                    
                    <div id="tab-bulkAllowance" class="tab-content hidden">
                        <div class="card p-6 max-w-lg">
                            <h3 class="text-lg font-semibold mb-4">Bulk Set by Program</h3>
                            <form id="bulkAllowanceForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Program *</label>
                                    <select name="program_id" required class="w-full" id="bulkAllowanceProgram"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Date *</label>
                                    <input type="date" name="date" required class="w-full">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Base Amount (SAR)</label>
                                        <input type="number" name="base_amount" value="50" step="0.01" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Bonus (SAR)</label>
                                        <input type="number" name="bonus_amount" value="0" step="0.01" class="w-full">
                                    </div>
                                </div>
                                <div class="bg-yellow-50 border border-yellow-200 p-3 rounded text-sm">
                                    ‚ö†Ô∏è This will set allowances for ALL active students in the selected program.
                                </div>
                                <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Set Bulk Allowances</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Programs Page -->
                <div id="page-programs" class="page-content hidden">
                    <div class="flex gap-4 mb-6">
                        <button class="tab-btn active px-4 py-2 font-medium" data-tab="viewPrograms">All Programs</button>
                        <button class="tab-btn px-4 py-2 font-medium text-gray-500" data-tab="createProgram">Create Program</button>
                    </div>
                    
                    <div id="tab-viewPrograms" class="tab-content">
                        <div class="card">
                            <div class="p-4 border-b flex justify-between items-center">
                                <span class="font-medium">Programs / Cost Centers</span>
                                <button onclick="loadPrograms()" class="btn-primary text-white px-4 py-2 rounded-lg">Refresh</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table>
                                    <thead><tr><th>Name</th><th>Cost Center</th><th>Default Allowance</th><th>Students</th><th>Teachers</th><th>Status</th><th>Actions</th></tr></thead>
                                    <tbody id="programsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-createProgram" class="tab-content hidden">
                        <div class="card p-6 max-w-lg">
                            <h3 class="text-lg font-semibold mb-4">Create New Program</h3>
                            <form id="createProgramForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Program Name *</label>
                                    <input type="text" name="name" required class="w-full" placeholder="e.g., Computer Science 2024">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Cost Center Code *</label>
                                    <input type="text" name="cost_center" required class="w-full" placeholder="e.g., CC-CS-2024">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Default Daily Allowance (SAR)</label>
                                    <input type="number" name="default_daily_allowance" value="50" step="0.01" class="w-full">
                                </div>
                                <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Create Program</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Telemetry Page -->
                <div id="page-telemetry" class="page-content hidden">
                    <div class="grid grid-cols-3 gap-6 mb-6">
                        <div class="card p-6">
                            <h3 class="font-semibold mb-4">üìä PostgreSQL</h3>
                            <div class="space-y-2 text-sm" id="pgTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3 class="font-semibold mb-4">üçÉ MongoDB</h3>
                            <div class="space-y-2 text-sm" id="mongoTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3 class="font-semibold mb-4">‚ö° Redis</h3>
                            <div class="space-y-2 text-sm" id="redisTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="font-semibold mb-4">üí≥ Transactions</h3>
                            <div class="space-y-2" id="txTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3 class="font-semibold mb-4">üìã Attendance</h3>
                            <div class="space-y-2" id="attTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        const API_BASE = '/dashboard/api';
        let authToken = localStorage.getItem('adminToken');
        let programs = [];
        let students = [];
        let transactionChart = null;
        let attendanceChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken) {
                verifySession();
            }
            setupEventListeners();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Sidebar navigation
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', () => navigateTo(item.dataset.page));
            });
            
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabGroup = e.target.closest('.page-content');
                    tabGroup.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    tabGroup.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    e.target.classList.add('active');
                    document.getElementById('tab-' + e.target.dataset.tab).classList.remove('hidden');
                });
            });
            
            // Forms
            document.getElementById('createUserForm').addEventListener('submit', handleCreateUser);
            document.getElementById('bulkStudentForm').addEventListener('submit', handleBulkStudents);
            document.getElementById('bulkTeacherForm').addEventListener('submit', handleBulkTeachers);
            document.getElementById('setAllowanceForm').addEventListener('submit', handleSetAllowance);
            document.getElementById('bulkAllowanceForm').addEventListener('submit', handleBulkAllowance);
            document.getElementById('createProgramForm').addEventListener('submit', handleCreateProgram);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    document.getElementById('adminName').textContent = data.full_name;
                    showDashboard();
                    loadDashboardData();
                } else {
                    document.getElementById('loginError').textContent = 'Invalid credentials';
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('loginError').textContent = 'Login failed: ' + err.message;
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        async function verifySession() {
            try {
                const res = await fetch(`${API_BASE}/auth/verify?token=${authToken}`);
                const data = await res.json();
                if (data.valid) {
                    showDashboard();
                    loadDashboardData();
                } else {
                    localStorage.removeItem('adminToken');
                    authToken = null;
                }
            } catch {
                localStorage.removeItem('adminToken');
                authToken = null;
            }
        }

        function handleLogout() {
            localStorage.removeItem('adminToken');
            authToken = null;
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
        }

        function navigateTo(page) {
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            
            const titles = { dashboard: 'Dashboard', users: 'User Management', bulk: 'Bulk Upload', allowances: 'Allowances', programs: 'Programs', telemetry: 'Telemetry' };
            document.getElementById('pageTitle').textContent = titles[page] || page;
            
            if (page === 'users') { loadStudents(); loadTeachers(); loadProgramSelects(); }
            if (page === 'bulk') { loadProgramSelects(); }
            if (page === 'allowances') { loadStudentSelect(); loadProgramSelects(); }
            if (page === 'programs') { loadPrograms(); }
            if (page === 'telemetry') { loadTelemetry(); }
        }

        async function loadDashboardData() {
            await loadHealth();
            await loadStats();
            await loadTrends();
            await loadPrograms();
        }

        async function loadHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                
                updateHealthDot('pgHealth', data.postgres.connected);
                updateHealthDot('mongoHealth', data.mongodb.connected);
                updateHealthDot('redisHealth', data.redis.connected);
                
                document.getElementById('pgStatus').textContent = data.postgres.connected ? 'Connected' : 'Disconnected';
                document.getElementById('mongoStatus').textContent = data.mongodb.connected ? 'Connected' : 'Disconnected';
                document.getElementById('redisStatus').textContent = data.redis.connected ? 'Connected' : 'Disconnected';
                
                const indicator = document.getElementById('healthIndicator');
                indicator.querySelector('.health-dot').className = `health-dot health-${data.overall === 'healthy' ? 'healthy' : 'unhealthy'}`;
                indicator.querySelector('span').textContent = data.overall === 'healthy' ? 'All Systems Healthy' : 'System Degraded';
            } catch (e) {
                console.error('Health check failed:', e);
            }
        }

        function updateHealthDot(id, healthy) {
            const dot = document.getElementById(id);
            dot.className = `health-dot health-${healthy ? 'healthy' : 'unhealthy'}`;
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                const data = await res.json();
                
                document.getElementById('statStudents').textContent = data.total_students;
                document.getElementById('statTeachers').textContent = data.total_teachers;
                document.getElementById('statTransactions').textContent = data.transactions_today;
                document.getElementById('statAttendance').textContent = data.attendance_today;
            } catch (e) {
                console.error('Stats failed:', e);
            }
        }

        async function loadTrends() {
            try {
                const [txRes, attRes] = await Promise.all([
                    fetch(`${API_BASE}/trends/transactions`),
                    fetch(`${API_BASE}/trends/attendance`)
                ]);
                
                const txData = await txRes.json();
                const attData = await attRes.json();
                
                if (transactionChart) transactionChart.destroy();
                if (attendanceChart) attendanceChart.destroy();
                
                const txCtx = document.getElementById('transactionChart').getContext('2d');
                transactionChart = new Chart(txCtx, {
                    type: 'line',
                    data: {
                        labels: txData.map(d => d.date),
                        datasets: [{
                            label: 'Transactions',
                            data: txData.map(d => d.count),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });
                
                const attCtx = document.getElementById('attendanceChart').getContext('2d');
                attendanceChart = new Chart(attCtx, {
                    type: 'line',
                    data: {
                        labels: attData.map(d => d.date),
                        datasets: [{
                            label: 'Attendance',
                            data: attData.map(d => d.count),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });
            } catch (e) {
                console.error('Trends failed:', e);
            }
        }

        async function loadStudents() {
            try {
                const res = await fetch(`${API_BASE}/students`);
                students = await res.json();
                
                const tbody = document.getElementById('studentsTable');
                tbody.innerHTML = students.map(s => `
                    <tr>
                        <td>${s.full_name}</td>
                        <td>${s.phone_number || '-'}</td>
                        <td>${s.program_name || '-'}</td>
                        <td><span class="px-2 py-1 rounded text-xs ${s.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${s.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button onclick="toggleUserStatus('${s.user_id}', ${!s.is_active})" class="text-blue-600 hover:underline text-sm">${s.is_active ? 'Deactivate' : 'Activate'}</button>
                            <button onclick="deleteUser('${s.user_id}')" class="text-red-600 hover:underline text-sm ml-2">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Load students failed:', e);
            }
        }

        async function loadTeachers() {
            try {
                const res = await fetch(`${API_BASE}/teachers`);
                const teachers = await res.json();
                
                const tbody = document.getElementById('teachersTable');
                tbody.innerHTML = teachers.map(t => `
                    <tr>
                        <td>${t.full_name}</td>
                        <td>${t.employee_id || '-'}</td>
                        <td>${t.program_name || '-'}</td>
                        <td><span class="px-2 py-1 rounded text-xs ${t.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${t.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button onclick="toggleUserStatus('${t.user_id}', ${!t.is_active})" class="text-blue-600 hover:underline text-sm">${t.is_active ? 'Deactivate' : 'Activate'}</button>
                            <button onclick="deleteUser('${t.user_id}')" class="text-red-600 hover:underline text-sm ml-2">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Load teachers failed:', e);
            }
        }

        async function loadPrograms() {
            try {
                const res = await fetch(`${API_BASE}/programs`);
                programs = await res.json();
                
                const tbody = document.getElementById('programsTable');
                if (tbody) {
                    tbody.innerHTML = programs.map(p => `
                        <tr>
                            <td>${p.name}</td>
                            <td>${p.cost_center}</td>
                            <td>${p.default_daily_allowance} SAR</td>
                            <td>${p.student_count}</td>
                            <td>${p.teacher_count}</td>
                            <td><span class="px-2 py-1 rounded text-xs ${p.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${p.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button onclick="deleteProgram('${p.program_id}')" class="text-red-600 hover:underline text-sm">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                console.error('Load programs failed:', e);
            }
        }

        function loadProgramSelects() {
            const selects = ['createUserProgram', 'bulkStudentProgram', 'bulkTeacherProgram', 'bulkAllowanceProgram'];
            const options = programs.map(p => `<option value="${p.program_id}">${p.name}</option>`).join('');
            selects.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<option value="">Select Program</option>' + options;
            });
        }

        async function loadStudentSelect() {
            if (students.length === 0) await loadStudents();
            const options = students.map(s => `<option value="${s.student_id}">${s.full_name}</option>`).join('');
            document.getElementById('allowanceStudent').innerHTML = '<option value="">Select Student</option>' + options;
        }

        async function loadAllowances() {
            const date = document.getElementById('allowanceDate').value;
            try {
                const url = date ? `${API_BASE}/allowances?filter_date=${date}` : `${API_BASE}/allowances`;
                const res = await fetch(url);
                const data = await res.json();
                
                const tbody = document.getElementById('allowancesTable');
                tbody.innerHTML = data.map(a => `
                    <tr>
                        <td>${a.full_name}</td>
                        <td>${a.date}</td>
                        <td>${a.base_amount} SAR</td>
                        <td>${a.bonus_amount} SAR</td>
                        <td><strong>${a.total_amount} SAR</strong></td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="text-center text-gray-500">No allowances found</td></tr>';
            } catch (e) {
                showToast('Failed to load allowances', 'error');
            }
        }

        async function loadTelemetry() {
            try {
                const res = await fetch(`${API_BASE}/telemetry`);
                const data = await res.json();
                
                document.getElementById('pgTelemetry').innerHTML = `
                    <div><strong>Database Size:</strong> ${data.postgres.database_size}</div>
                    <div class="mt-2"><strong>Tables:</strong></div>
                    ${Object.entries(data.postgres.table_counts).map(([k,v]) => `<div class="text-gray-600 pl-2">${k}: ${v} rows</div>`).join('')}
                `;
                
                document.getElementById('mongoTelemetry').innerHTML = `
                    <div><strong>Total Documents:</strong> ${data.mongodb.total_documents}</div>
                    <div class="mt-2"><strong>Collections:</strong></div>
                    ${Object.entries(data.mongodb.collections).map(([k,v]) => `<div class="text-gray-600 pl-2">${k}: ${v}</div>`).join('')}
                `;
                
                document.getElementById('redisTelemetry').innerHTML = `
                    <div><strong>Memory:</strong> ${data.redis.memory}</div>
                    <div><strong>Total Keys:</strong> ${data.redis.keys}</div>
                `;
                
                document.getElementById('txTelemetry').innerHTML = `
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-gray-50 p-4 rounded"><div class="text-2xl font-bold">${data.transactions.today}</div><div class="text-xs text-gray-500">Today</div></div>
                        <div class="bg-gray-50 p-4 rounded"><div class="text-2xl font-bold">${data.transactions.week}</div><div class="text-xs text-gray-500">This Week</div></div>
                        <div class="bg-gray-50 p-4 rounded"><div class="text-2xl font-bold">${data.transactions.month}</div><div class="text-xs text-gray-500">This Month</div></div>
                    </div>
                `;
                
                document.getElementById('attTelemetry').innerHTML = `
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-gray-50 p-4 rounded"><div class="text-2xl font-bold">${data.attendance.today}</div><div class="text-xs text-gray-500">Today</div></div>
                        <div class="bg-gray-50 p-4 rounded"><div class="text-2xl font-bold">${data.attendance.week}</div><div class="text-xs text-gray-500">This Week</div></div>
                    </div>
                `;
            } catch (e) {
                console.error('Telemetry failed:', e);
            }
        }

        function toggleUserFields(role) {
            document.getElementById('studentFields').classList.toggle('hidden', role !== 'student');
            document.getElementById('teacherFields').classList.toggle('hidden', role !== 'teacher');
        }

        async function handleCreateUser(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form));
            
            try {
                const res = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    showToast('User created successfully!', 'success');
                    form.reset();
                    loadStudents();
                    loadTeachers();
                } else {
                    showToast(result.detail || 'Failed to create user', 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function toggleUserStatus(userId, isActive) {
            try {
                const res = await fetch(`${API_BASE}/users/${userId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: isActive })
                });
                if (res.ok) {
                    showToast('Status updated', 'success');
                    loadStudents();
                    loadTeachers();
                }
            } catch (e) {
                showToast('Failed to update status', 'error');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            try {
                const res = await fetch(`${API_BASE}/users/${userId}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('User deleted', 'success');
                    loadStudents();
                    loadTeachers();
                }
            } catch (e) {
                showToast('Failed to delete user', 'error');
            }
        }

        async function handleBulkStudents(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            try {
                const res = await fetch(`${API_BASE}/bulk/students`, { method: 'POST', body: formData });
                const result = await res.json();
                
                document.getElementById('bulkStudentResult').innerHTML = `
                    <div class="bg-green-50 border border-green-200 p-3 rounded">
                        ‚úÖ Created ${result.created} students
                        ${result.errors.length > 0 ? `<br><span class="text-red-600">Errors: ${result.errors.length}</span>` : ''}
                    </div>
                `;
                loadStudents();
            } catch (e) {
                document.getElementById('bulkStudentResult').innerHTML = `<div class="bg-red-50 border border-red-200 p-3 rounded text-red-600">Error: ${e.message}</div>`;
            }
        }

        async function handleBulkTeachers(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            try {
                const res = await fetch(`${API_BASE}/bulk/teachers`, { method: 'POST', body: formData });
                const result = await res.json();
                
                document.getElementById('bulkTeacherResult').innerHTML = `
                    <div class="bg-green-50 border border-green-200 p-3 rounded">
                        ‚úÖ Created ${result.created} teachers
                        ${result.errors.length > 0 ? `<br><span class="text-red-600">Errors: ${result.errors.length}</span>` : ''}
                    </div>
                `;
                loadTeachers();
            } catch (e) {
                document.getElementById('bulkTeacherResult').innerHTML = `<div class="bg-red-50 border border-red-200 p-3 rounded text-red-600">Error: ${e.message}</div>`;
            }
        }

        async function handleSetAllowance(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            
            try {
                const res = await fetch(`${API_BASE}/allowances`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showToast('Allowance set successfully!', 'success');
                    e.target.reset();
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function handleBulkAllowance(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            
            try {
                const res = await fetch(`${API_BASE}/allowances/bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    showToast(`Allowances set for ${result.count} students!`, 'success');
                    e.target.reset();
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function handleCreateProgram(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            
            try {
                const res = await fetch(`${API_BASE}/programs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showToast('Program created!', 'success');
                    e.target.reset();
                    loadPrograms();
                    loadProgramSelects();
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function deleteProgram(programId) {
            if (!confirm('Are you sure you want to delete this program?')) return;
            try {
                const res = await fetch(`${API_BASE}/programs/${programId}`, { method: 'DELETE' });
                const result = await res.json();
                if (res.ok) {
                    showToast('Program deleted', 'success');
                    loadPrograms();
                } else {
                    showToast(result.detail || 'Cannot delete program', 'error');
                }
            } catch (e) {
                showToast('Failed to delete program', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
            const toast = document.createElement('div');
            toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg`;
            toast.textContent = message;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
    </script>
</body>
</html>
