<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        enterprise: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617'
                        },
                        accent: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a'
                        },
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>
    <style>
        * { 
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif; 
        }
        
        code, pre, .mono {
            font-family: 'IBM Plex Mono', monospace;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Enterprise Sidebar */
        .sidebar {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
            border-right: 1px solid rgba(255,255,255,0.05);
        }
        
        .sidebar-item {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 3px solid transparent;
            margin: 2px 12px;
            border-radius: 6px;
        }
        
        .sidebar-item:hover {
            background: rgba(255,255,255,0.05);
            border-left-color: rgba(59, 130, 246, 0.5);
        }
        
        .sidebar-item.active {
            background: rgba(59, 130, 246, 0.15);
            border-left-color: #3b82f6;
        }
        
        .sidebar-item.active i {
            color: #3b82f6;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
            transition: box-shadow 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.06), 0 2px 4px rgba(0,0,0,0.04);
        }

        /* Stat Cards */
        .stat-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(59,130,246,0.2) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }
        
        .stat-card .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(37, 99, 235, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: white;
            color: #334155;
            border: 1px solid #e2e8f0;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        /* Form Elements */
        input, select, textarea {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        input::placeholder {
            color: #94a3b8;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 14px 16px;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #475569;
        }
        
        td {
            padding: 14px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            color: #334155;
        }
        
        tr:hover td {
            background: #f8fafc;
        }

        /* Tabs */
        .tab-btn {
            position: relative;
            padding: 12px 16px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s ease;
        }
        
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: transparent;
            transition: background 0.2s ease;
        }
        
        .tab-btn:hover {
            color: #334155;
        }
        
        .tab-btn.active {
            color: #3b82f6;
        }
        
        .tab-btn.active::after {
            background: #3b82f6;
        }

        /* Health Indicators */
        .health-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: relative;
        }
        
        .health-healthy {
            background: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .health-unhealthy {
            background: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        
        .health-unknown {
            background: #94a3b8;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Toast */
        .toast {
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(8px);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        /* Service Health Cards */
        .service-card {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .service-card:hover {
            border-color: #cbd5e1;
        }
        
        .service-card.healthy {
            border-left: 3px solid #10b981;
        }
        
        .service-card.unhealthy {
            border-left: 3px solid #ef4444;
        }

        /* Charts Container */
        .chart-container {
            position: relative;
            padding: 20px;
        }

        /* Page Transitions */
        .page-content {
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Login Screen */
        .login-container {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            position: relative;
            overflow: hidden;
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 80%;
            height: 150%;
            background: radial-gradient(ellipse, rgba(59, 130, 246, 0.15) 0%, transparent 60%);
            pointer-events: none;
        }
        
        .login-container::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -20%;
            width: 60%;
            height: 100%;
            background: radial-gradient(ellipse, rgba(59, 130, 246, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Header */
        .main-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Action Links */
        .action-link {
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s ease;
        }
        
        .action-link-primary {
            color: #3b82f6;
        }
        
        .action-link-primary:hover {
            color: #2563eb;
            text-decoration: underline;
        }
        
        .action-link-danger {
            color: #ef4444;
        }
        
        .action-link-danger:hover {
            color: #dc2626;
            text-decoration: underline;
        }

        /* Info Boxes */
        .info-box {
            border-radius: 8px;
            padding: 14px 16px;
            font-size: 13px;
        }
        
        .info-box-warning {
            background: #fffbeb;
            border: 1px solid #fde68a;
            color: #92400e;
        }
        
        .info-box-success {
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .info-box-info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
        }

        /* Telemetry Stats */
        .telemetry-stat {
            background: #f8fafc;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        
        .telemetry-stat .value {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
        }
        
        .telemetry-stat .label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-top: 4px;
        }

        /* Logo */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body class="bg-enterprise-50">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center login-container">
        <div class="login-card p-10 w-full max-w-md relative z-10">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-accent-500 to-accent-700 rounded-2xl mb-4 shadow-lg shadow-accent-500/25">
                    <i class="fas fa-graduation-cap text-2xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-enterprise-900 tracking-tight">Academy Admin</h1>
                <p class="text-enterprise-500 mt-1 text-sm">Enterprise Management Platform</p>
            </div>
            <form id="loginForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Email Address</label>
                    <input type="email" id="loginEmail" class="w-full" placeholder="admin@academy.edu" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full" placeholder="Enter your password" required>
                </div>
                <div id="loginError" class="text-danger text-sm hidden bg-red-50 border border-red-200 rounded-lg p-3"></div>
                <button type="submit" class="w-full btn-primary py-3 text-base">
                    Sign In
                </button>
            </form>
            <p class="text-center text-enterprise-400 text-xs mt-6">
                Secure enterprise authentication
            </p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden">
        <!-- Sidebar -->
        <div class="fixed left-0 top-0 h-full w-64 sidebar text-white z-50">
            <div class="p-6 border-b border-white/10">
                <div class="logo-container">
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div>
                        <h1 class="font-semibold text-base text-white">Academy Admin</h1>
                        <p class="text-xs text-enterprise-400" id="adminName">Administrator</p>
                    </div>
                </div>
            </div>
            <nav class="py-4">
                <div class="px-4 mb-2">
                    <span class="text-[10px] uppercase tracking-wider text-enterprise-500 font-medium">Main Menu</span>
                </div>
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center gap-3 active" data-page="dashboard">
                    <i class="fas fa-th-large w-5 text-center text-enterprise-400"></i>
                    <span class="text-sm font-medium">Dashboard</span>
                </div>
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center gap-3" data-page="users">
                    <i class="fas fa-users w-5 text-center text-enterprise-400"></i>
                    <span class="text-sm font-medium">User Management</span>
                </div>
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center gap-3" data-page="bulk">
                    <i class="fas fa-cloud-upload-alt w-5 text-center text-enterprise-400"></i>
                    <span class="text-sm font-medium">Bulk Upload</span>
                </div>
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center gap-3" data-page="allowances">
                    <i class="fas fa-wallet w-5 text-center text-enterprise-400"></i>
                    <span class="text-sm font-medium">Allowances</span>
                </div>
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center gap-3" data-page="programs">
                    <i class="fas fa-sitemap w-5 text-center text-enterprise-400"></i>
                    <span class="text-sm font-medium">Programs</span>
                </div>
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center gap-3" data-page="telemetry">
                    <i class="fas fa-chart-bar w-5 text-center text-enterprise-400"></i>
                    <span class="text-sm font-medium">Telemetry</span>
                </div>
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-white/10">
                <button id="logoutBtn" class="w-full bg-white/5 hover:bg-white/10 py-2.5 rounded-lg flex items-center justify-center gap-2 text-sm font-medium text-enterprise-300 transition-colors">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="ml-64 min-h-screen">
            <!-- Header -->
            <header class="main-header px-8 py-4 flex items-center justify-between sticky top-0 z-40">
                <div>
                    <h2 id="pageTitle" class="text-xl font-semibold text-enterprise-900">Dashboard</h2>
                    <p class="text-sm text-enterprise-500" id="pageBreadcrumb">Overview & Analytics</p>
                </div>
                <div class="flex items-center gap-6">
                    <div id="healthIndicator" class="flex items-center gap-2 text-sm bg-enterprise-50 px-4 py-2 rounded-lg">
                        <div class="health-dot health-unknown"></div>
                        <span class="text-enterprise-600 font-medium">Checking status...</span>
                    </div>
                    <button onclick="location.reload()" class="btn-secondary px-4 py-2 flex items-center gap-2">
                        <i class="fas fa-sync-alt text-xs"></i> Refresh
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <main class="p-8">
                <!-- Dashboard Page -->
                <div id="page-dashboard" class="page-content">
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-4 gap-6 mb-8">
                        <div class="stat-card text-white p-6 rounded-xl">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="text-sm text-enterprise-300 font-medium mb-1">Total Students</div>
                                    <div class="text-3xl font-bold" id="statStudents">—</div>
                                </div>
                                <div class="stat-icon bg-accent-500/20">
                                    <i class="fas fa-user-graduate text-accent-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card text-white p-6 rounded-xl">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="text-sm text-enterprise-300 font-medium mb-1">Total Teachers</div>
                                    <div class="text-3xl font-bold" id="statTeachers">—</div>
                                </div>
                                <div class="stat-icon bg-emerald-500/20">
                                    <i class="fas fa-chalkboard-teacher text-emerald-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card text-white p-6 rounded-xl">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="text-sm text-enterprise-300 font-medium mb-1">Transactions Today</div>
                                    <div class="text-3xl font-bold" id="statTransactions">—</div>
                                </div>
                                <div class="stat-icon bg-amber-500/20">
                                    <i class="fas fa-receipt text-amber-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card text-white p-6 rounded-xl">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="text-sm text-enterprise-300 font-medium mb-1">Attendance Today</div>
                                    <div class="text-3xl font-bold" id="statAttendance">—</div>
                                </div>
                                <div class="stat-icon bg-purple-500/20">
                                    <i class="fas fa-clipboard-check text-purple-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Service Health -->
                    <div class="card p-6 mb-8">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-lg font-semibold text-enterprise-900">Service Health</h3>
                                <p class="text-sm text-enterprise-500">Real-time infrastructure status</p>
                            </div>
                            <span class="badge badge-success">
                                <i class="fas fa-circle text-[6px] mr-2"></i> Monitoring Active
                            </span>
                        </div>
                        <div class="grid grid-cols-3 gap-4" id="serviceHealth">
                            <div class="service-card" id="pgServiceCard">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center">
                                        <i class="fas fa-database text-blue-600"></i>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-enterprise-900">PostgreSQL</span>
                                        <div class="flex items-center gap-2 mt-0.5">
                                            <div class="health-dot health-unknown" id="pgHealth"></div>
                                            <span class="text-xs text-enterprise-500" id="pgStatus">Checking...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="service-card" id="mongoServiceCard">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center">
                                        <i class="fas fa-leaf text-green-600"></i>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-enterprise-900">MongoDB</span>
                                        <div class="flex items-center gap-2 mt-0.5">
                                            <div class="health-dot health-unknown" id="mongoHealth"></div>
                                            <span class="text-xs text-enterprise-500" id="mongoStatus">Checking...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="service-card" id="redisServiceCard">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center">
                                        <i class="fas fa-bolt text-red-600"></i>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-enterprise-900">Redis</span>
                                        <div class="flex items-center gap-2 mt-0.5">
                                            <div class="health-dot health-unknown" id="redisHealth"></div>
                                            <span class="text-xs text-enterprise-500" id="redisStatus">Checking...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-2 gap-6">
                        <div class="card">
                            <div class="px-6 py-4 border-b border-enterprise-100">
                                <h3 class="font-semibold text-enterprise-900">Transaction Trend</h3>
                                <p class="text-sm text-enterprise-500">Last 7 days</p>
                            </div>
                            <div class="p-6">
                                <canvas id="transactionChart" height="200"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <div class="px-6 py-4 border-b border-enterprise-100">
                                <h3 class="font-semibold text-enterprise-900">Attendance Trend</h3>
                                <p class="text-sm text-enterprise-500">Last 7 days</p>
                            </div>
                            <div class="p-6">
                                <canvas id="attendanceChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Page -->
                <div id="page-users" class="page-content hidden">
                    <div class="flex gap-1 mb-6 border-b border-enterprise-200">
                        <button class="tab-btn active" data-tab="students">Students</button>
                        <button class="tab-btn" data-tab="teachers">Teachers</button>
                        <button class="tab-btn" data-tab="create">Create User</button>
                    </div>
                    
                    <div id="tab-students" class="tab-content">
                        <div class="card">
                            <div class="p-4 border-b border-enterprise-100 flex justify-between items-center">
                                <div class="relative">
                                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-enterprise-400 text-sm"></i>
                                    <input type="text" id="searchStudents" placeholder="Search students..." class="pl-10 w-72">
                                </div>
                                <button onclick="loadStudents()" class="btn-secondary flex items-center gap-2">
                                    <i class="fas fa-sync-alt text-xs"></i> Refresh
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table>
                                    <thead><tr><th>Name</th><th>Phone Number</th><th>Program</th><th>Status</th><th>Actions</th></tr></thead>
                                    <tbody id="studentsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-teachers" class="tab-content hidden">
                        <div class="card">
                            <div class="p-4 border-b border-enterprise-100 flex justify-between items-center">
                                <div class="relative">
                                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-enterprise-400 text-sm"></i>
                                    <input type="text" id="searchTeachers" placeholder="Search teachers..." class="pl-10 w-72">
                                </div>
                                <button onclick="loadTeachers()" class="btn-secondary flex items-center gap-2">
                                    <i class="fas fa-sync-alt text-xs"></i> Refresh
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table>
                                    <thead><tr><th>Name</th><th>Program</th><th>Status</th><th>Actions</th></tr></thead>
                                    <tbody id="teachersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-create" class="tab-content hidden">
                        <div class="card p-8 max-w-2xl">
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-enterprise-900">Create New User</h3>
                                <p class="text-sm text-enterprise-500">Add a new user to the system</p>
                            </div>
                            <form id="createUserForm" class="space-y-5">
                                <div class="grid grid-cols-2 gap-5">
                                    <div>
                                        <label class="block text-sm font-medium text-enterprise-700 mb-2">Full Name <span class="text-danger">*</span></label>
                                        <input type="text" name="full_name" required class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-enterprise-700 mb-2">Email <span class="text-danger">*</span></label>
                                        <input type="email" name="email" required class="w-full">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-5">
                                    <div>
                                        <label class="block text-sm font-medium text-enterprise-700 mb-2">Role <span class="text-danger">*</span></label>
                                        <select name="role" required class="w-full" onchange="toggleUserFields(this.value)">
                                            <option value="student">Student</option>
                                            <option value="teacher">Teacher</option>
                                            <option value="store">Store Staff</option>
                                        </select>
                                    </div>
                                    <div id="programSelectContainer">
                                        <label class="block text-sm font-medium text-enterprise-700 mb-2">Program</label>
                                        <select name="program_id" class="w-full" id="createUserProgram"></select>
                                    </div>
                                </div>
                                <div id="studentFields">
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Phone Number</label>
                                    <input type="text" name="phone_number" class="w-full" placeholder="+966501234567">
                                    <p class="text-xs text-enterprise-500 mt-2">Saudi format: +966 followed by 9 digits, or 05XXXXXXXX</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Password</label>
                                    <input type="password" name="password" class="w-full" placeholder="Leave blank for default (temp123)">
                                </div>
                                <div class="pt-2">
                                    <button type="submit" class="btn-primary">Create User</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Bulk Upload Page -->
                <div id="page-bulk" class="page-content hidden">
                    <div class="grid grid-cols-2 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 rounded-lg bg-accent-50 flex items-center justify-center">
                                    <i class="fas fa-user-graduate text-accent-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-enterprise-900">Bulk Upload Students</h3>
                                    <p class="text-sm text-enterprise-500">Import multiple students via CSV</p>
                                </div>
                            </div>
                            <form id="bulkStudentForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Program <span class="text-danger">*</span></label>
                                    <select name="program_id" required class="w-full" id="bulkStudentProgram"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">CSV File <span class="text-danger">*</span></label>
                                    <input type="file" name="file" accept=".csv" required class="w-full">
                                </div>
                                <div class="info-box info-box-info">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    Required columns: <code class="mono text-xs bg-white/50 px-1.5 py-0.5 rounded">full_name, email, phone_number</code>
                                </div>
                                <button type="submit" class="btn-primary">Upload Students</button>
                            </form>
                            <div id="bulkStudentResult" class="mt-4"></div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 rounded-lg bg-emerald-50 flex items-center justify-center">
                                    <i class="fas fa-chalkboard-teacher text-emerald-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-enterprise-900">Bulk Upload Teachers</h3>
                                    <p class="text-sm text-enterprise-500">Import multiple teachers via CSV</p>
                                </div>
                            </div>
                            <form id="bulkTeacherForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Program <span class="text-danger">*</span></label>
                                    <select name="program_id" required class="w-full" id="bulkTeacherProgram"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">CSV File <span class="text-danger">*</span></label>
                                    <input type="file" name="file" accept=".csv" required class="w-full">
                                </div>
                                <div class="info-box info-box-info">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    Required columns: <code class="mono text-xs bg-white/50 px-1.5 py-0.5 rounded">full_name, email</code>
                                </div>
                                <button type="submit" class="btn-primary">Upload Teachers</button>
                            </form>
                            <div id="bulkTeacherResult" class="mt-4"></div>
                        </div>
                    </div>
                    
                    <div class="card p-6 mt-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-lg bg-enterprise-100 flex items-center justify-center">
                                <i class="fas fa-file-csv text-enterprise-600"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-enterprise-900">CSV Format Reference</h3>
                                <p class="text-sm text-enterprise-500">Template examples for bulk uploads</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-medium text-enterprise-800 mb-3">Student CSV Template</h4>
                                <pre class="bg-enterprise-50 border border-enterprise-200 p-4 rounded-lg text-sm mono overflow-x-auto">full_name,email,phone_number
Ahmed Mohammed,ahmed@academy.edu,+966501234567
Sara Abdullah,sara@academy.edu,+966501234568</pre>
                            </div>
                            <div>
                                <h4 class="font-medium text-enterprise-800 mb-3">Teacher CSV Template</h4>
                                <pre class="bg-enterprise-50 border border-enterprise-200 p-4 rounded-lg text-sm mono overflow-x-auto">full_name,email
Dr. Khalid Ibrahim,khalid@academy.edu
Dr. Fatima Al-Saud,fatima@academy.edu</pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Allowances Page -->
                <div id="page-allowances" class="page-content hidden">
                    <div class="flex gap-1 mb-6 border-b border-enterprise-200">
                        <button class="tab-btn active" data-tab="viewAllowances">View Allowances</button>
                        <button class="tab-btn" data-tab="setAllowance">Set Individual</button>
                        <button class="tab-btn" data-tab="bulkAllowance">Bulk Set</button>
                        <button class="tab-btn" data-tab="addSupplement">Add Supplement</button>
                    </div>
                    
                    <div id="tab-viewAllowances" class="tab-content">
                        <div class="card">
                            <div class="p-4 border-b border-enterprise-100 flex items-center gap-4">
                                <label class="text-sm font-medium text-enterprise-700">Filter by Date:</label>
                                <input type="date" id="allowanceDate" class="w-48">
                                <button onclick="loadAllowances()" class="btn-primary">Load Allowances</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table>
                                    <thead><tr><th>Student</th><th>Date</th><th>Base Amount</th><th>Supplement</th><th>Total</th></tr></thead>
                                    <tbody id="allowancesTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-setAllowance" class="tab-content hidden">
                        <div class="card p-8 max-w-lg">
                            <div class="mb-6">
                                <h3 class="font-semibold text-enterprise-900">Set Individual Allowance</h3>
                                <p class="text-sm text-enterprise-500">Configure allowance for a specific student</p>
                            </div>
                            <form id="setAllowanceForm" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Student <span class="text-danger">*</span></label>
                                    <select name="student_id" required class="w-full" id="allowanceStudent"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Date <span class="text-danger">*</span></label>
                                    <input type="date" name="date" required class="w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Base Amount (SAR)</label>
                                    <input type="number" name="base_amount" value="50" step="0.01" class="w-full">
                                </div>
                                <button type="submit" class="btn-primary">Set Allowance</button>
                            </form>
                        </div>
                    </div>
                    
                    <div id="tab-bulkAllowance" class="tab-content hidden">
                        <div class="card p-8 max-w-lg">
                            <div class="mb-6">
                                <h3 class="font-semibold text-enterprise-900">Bulk Set by Program</h3>
                                <p class="text-sm text-enterprise-500">Set allowances for all students in a program</p>
                            </div>
                            <form id="bulkAllowanceForm" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Program <span class="text-danger">*</span></label>
                                    <select name="program_id" required class="w-full" id="bulkAllowanceProgram"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Date <span class="text-danger">*</span></label>
                                    <input type="date" name="date" required class="w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Base Amount (SAR)</label>
                                    <input type="number" name="base_amount" value="50" step="0.01" class="w-full">
                                </div>
                                <div class="info-box info-box-warning">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    This will set allowances for <strong>all active students</strong> in the selected program.
                                </div>
                                <button type="submit" class="btn-primary">Set Bulk Allowances</button>
                            </form>
                        </div>
                    </div>
                    
                    <div id="tab-addSupplement" class="tab-content hidden">
                        <div class="card p-8 max-w-lg">
                            <div class="mb-6">
                                <h3 class="font-semibold text-enterprise-900">Add Supplement</h3>
                                <p class="text-sm text-enterprise-500">Add a supplement amount to an existing allowance</p>
                            </div>
                            <form id="addSupplementForm" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Recipient Type <span class="text-danger">*</span></label>
                                    <select name="type" required class="w-full" id="supplementType" onchange="updateSupplementTargets()">
                                        <option value="student">Student</option>
                                        <option value="teacher">Teacher</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Select Recipient <span class="text-danger">*</span></label>
                                    <select name="target_id" required class="w-full" id="supplementTarget"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Date</label>
                                    <input type="date" name="date" class="w-full" id="supplementDate">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Supplement Amount (SAR) <span class="text-danger">*</span></label>
                                    <input type="number" name="amount" required step="0.01" class="w-full" placeholder="e.g., 25.00">
                                </div>
                                <div class="info-box info-box-success">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    This amount will be added to the recipient's existing allowance for the selected date.
                                </div>
                                <button type="submit" class="btn-primary">Add Supplement</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Programs Page -->
                <div id="page-programs" class="page-content hidden">
                    <div class="flex gap-1 mb-6 border-b border-enterprise-200">
                        <button class="tab-btn active" data-tab="viewPrograms">All Programs</button>
                        <button class="tab-btn" data-tab="createProgram">Create Program</button>
                    </div>
                    
                    <div id="tab-viewPrograms" class="tab-content">
                        <div class="card">
                            <div class="p-4 border-b border-enterprise-100 flex justify-between items-center">
                                <span class="font-medium text-enterprise-800">Programs / Cost Centers</span>
                                <button onclick="loadPrograms()" class="btn-secondary flex items-center gap-2">
                                    <i class="fas fa-sync-alt text-xs"></i> Refresh
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table>
                                    <thead><tr><th>Name</th><th>Cost Center</th><th>Default Allowance</th><th>Students</th><th>Teachers</th><th>Status</th><th>Actions</th></tr></thead>
                                    <tbody id="programsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-createProgram" class="tab-content hidden">
                        <div class="card p-8 max-w-lg">
                            <div class="mb-6">
                                <h3 class="font-semibold text-enterprise-900">Create New Program</h3>
                                <p class="text-sm text-enterprise-500">Add a new program or cost center</p>
                            </div>
                            <form id="createProgramForm" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Program Name <span class="text-danger">*</span></label>
                                    <input type="text" name="name" required class="w-full" placeholder="e.g., Computer Science 2024">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Cost Center Code <span class="text-danger">*</span></label>
                                    <input type="text" name="cost_center" required class="w-full" placeholder="e.g., CC-CS-2024">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Default Daily Allowance (SAR)</label>
                                    <input type="number" name="default_daily_allowance" value="50" step="0.01" class="w-full">
                                </div>
                                <button type="submit" class="btn-primary">Create Program</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Telemetry Page -->
                <div id="page-telemetry" class="page-content hidden">
                    <div class="grid grid-cols-3 gap-6 mb-6">
                        <div class="card p-6">
                            <div class="flex items-center gap-3 mb-5">
                                <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center">
                                    <i class="fas fa-database text-blue-600"></i>
                                </div>
                                <h3 class="font-semibold text-enterprise-900">PostgreSQL</h3>
                            </div>
                            <div class="space-y-2 text-sm" id="pgTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center gap-3 mb-5">
                                <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center">
                                    <i class="fas fa-leaf text-green-600"></i>
                                </div>
                                <h3 class="font-semibold text-enterprise-900">MongoDB</h3>
                            </div>
                            <div class="space-y-2 text-sm" id="mongoTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center gap-3 mb-5">
                                <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center">
                                    <i class="fas fa-bolt text-red-600"></i>
                                </div>
                                <h3 class="font-semibold text-enterprise-900">Redis</h3>
                            </div>
                            <div class="space-y-2 text-sm" id="redisTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center gap-3 mb-5">
                                <div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center">
                                    <i class="fas fa-receipt text-purple-600"></i>
                                </div>
                                <h3 class="font-semibold text-enterprise-900">Transactions</h3>
                            </div>
                            <div class="space-y-2" id="txTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center gap-3 mb-5">
                                <div class="w-10 h-10 rounded-lg bg-teal-50 flex items-center justify-center">
                                    <i class="fas fa-clipboard-check text-teal-600"></i>
                                </div>
                                <h3 class="font-semibold text-enterprise-900">Attendance</h3>
                            </div>
                            <div class="space-y-2" id="attTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-3"></div>

    <script>
        const API_BASE = '/dashboard/api';
        let authToken = localStorage.getItem('adminToken');
        let programs = [];
        let students = [];
        let teachers = [];
        let transactionChart = null;
        let attendanceChart = null;

        // Chart.js default configuration
        Chart.defaults.font.family = "'IBM Plex Sans', sans-serif";
        Chart.defaults.color = '#64748b';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken) {
                verifySession();
            }
            setupEventListeners();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Sidebar navigation
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', () => navigateTo(item.dataset.page));
            });
            
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabGroup = e.target.closest('.page-content');
                    tabGroup.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    tabGroup.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    e.target.classList.add('active');
                    document.getElementById('tab-' + e.target.dataset.tab).classList.remove('hidden');
                });
            });
            
            // Forms
            document.getElementById('createUserForm').addEventListener('submit', handleCreateUser);
            document.getElementById('bulkStudentForm').addEventListener('submit', handleBulkStudents);
            document.getElementById('bulkTeacherForm').addEventListener('submit', handleBulkTeachers);
            document.getElementById('setAllowanceForm').addEventListener('submit', handleSetAllowance);
            document.getElementById('bulkAllowanceForm').addEventListener('submit', handleBulkAllowance);
            document.getElementById('createProgramForm').addEventListener('submit', handleCreateProgram);
            document.getElementById('addSupplementForm').addEventListener('submit', handleAddSupplement);
            
            // Set default date for supplement
            document.getElementById('supplementDate').valueAsDate = new Date();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    document.getElementById('adminName').textContent = data.full_name;
                    showDashboard();
                    loadDashboardData();
                } else {
                    document.getElementById('loginError').textContent = 'Invalid credentials. Please try again.';
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('loginError').textContent = 'Connection failed. Please check your network.';
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        async function verifySession() {
            try {
                const res = await fetch(`${API_BASE}/auth/verify?token=${authToken}`);
                const data = await res.json();
                if (data.valid) {
                    showDashboard();
                    loadDashboardData();
                } else {
                    localStorage.removeItem('adminToken');
                    authToken = null;
                }
            } catch {
                localStorage.removeItem('adminToken');
                authToken = null;
            }
        }

        function handleLogout() {
            localStorage.removeItem('adminToken');
            authToken = null;
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
        }

        const pageBreadcrumbs = {
            dashboard: 'Overview & Analytics',
            users: 'Manage Students & Teachers',
            bulk: 'Import Data via CSV',
            allowances: 'Financial Management',
            programs: 'Cost Centers & Programs',
            telemetry: 'System Monitoring'
        };

        function navigateTo(page) {
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            
            const titles = { dashboard: 'Dashboard', users: 'User Management', bulk: 'Bulk Upload', allowances: 'Allowances', programs: 'Programs', telemetry: 'Telemetry' };
            document.getElementById('pageTitle').textContent = titles[page] || page;
            document.getElementById('pageBreadcrumb').textContent = pageBreadcrumbs[page] || '';
            
            if (page === 'users') { loadStudents(); loadTeachers(); loadProgramSelects(); }
            if (page === 'bulk') { loadProgramSelects(); }
            if (page === 'allowances') { loadStudentSelect(); loadProgramSelects(); updateSupplementTargets(); }
            if (page === 'programs') { loadPrograms(); }
            if (page === 'telemetry') { loadTelemetry(); }
        }

        async function loadDashboardData() {
            await loadHealth();
            await loadStats();
            await loadTrends();
            await loadPrograms();
        }

        async function loadHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                
                updateHealthDot('pgHealth', data.postgres.connected);
                updateHealthDot('mongoHealth', data.mongodb.connected);
                updateHealthDot('redisHealth', data.redis.connected);
                
                // Update service cards
                document.getElementById('pgServiceCard').classList.toggle('healthy', data.postgres.connected);
                document.getElementById('pgServiceCard').classList.toggle('unhealthy', !data.postgres.connected);
                document.getElementById('mongoServiceCard').classList.toggle('healthy', data.mongodb.connected);
                document.getElementById('mongoServiceCard').classList.toggle('unhealthy', !data.mongodb.connected);
                document.getElementById('redisServiceCard').classList.toggle('healthy', data.redis.connected);
                document.getElementById('redisServiceCard').classList.toggle('unhealthy', !data.redis.connected);
                
                document.getElementById('pgStatus').textContent = data.postgres.connected ? 'Connected' : 'Disconnected';
                document.getElementById('mongoStatus').textContent = data.mongodb.connected ? 'Connected' : 'Disconnected';
                document.getElementById('redisStatus').textContent = data.redis.connected ? 'Connected' : 'Disconnected';
                
                const indicator = document.getElementById('healthIndicator');
                indicator.querySelector('.health-dot').className = `health-dot health-${data.overall === 'healthy' ? 'healthy' : 'unhealthy'}`;
                indicator.querySelector('span').textContent = data.overall === 'healthy' ? 'All Systems Operational' : 'System Degraded';
            } catch (e) {
                console.error('Health check failed:', e);
            }
        }

        function updateHealthDot(id, healthy) {
            const dot = document.getElementById(id);
            dot.className = `health-dot health-${healthy ? 'healthy' : 'unhealthy'}`;
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                const data = await res.json();
                
                document.getElementById('statStudents').textContent = data.total_students.toLocaleString();
                document.getElementById('statTeachers').textContent = data.total_teachers.toLocaleString();
                document.getElementById('statTransactions').textContent = data.transactions_today.toLocaleString();
                document.getElementById('statAttendance').textContent = data.attendance_today.toLocaleString();
            } catch (e) {
                console.error('Stats failed:', e);
            }
        }

        async function loadTrends() {
            try {
                const [txRes, attRes] = await Promise.all([
                    fetch(`${API_BASE}/trends/transactions`),
                    fetch(`${API_BASE}/trends/attendance`)
                ]);
                
                const txData = await txRes.json();
                const attData = await attRes.json();
                
                if (transactionChart) transactionChart.destroy();
                if (attendanceChart) attendanceChart.destroy();
                
                const txCtx = document.getElementById('transactionChart').getContext('2d');
                transactionChart = new Chart(txCtx, {
                    type: 'line',
                    data: {
                        labels: txData.map(d => d.date),
                        datasets: [{
                            label: 'Transactions',
                            data: txData.map(d => d.count),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.08)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#f1f5f9' },
                                ticks: { font: { size: 11 } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 11 } }
                            }
                        }
                    }
                });
                
                const attCtx = document.getElementById('attendanceChart').getContext('2d');
                attendanceChart = new Chart(attCtx, {
                    type: 'line',
                    data: {
                        labels: attData.map(d => d.date),
                        datasets: [{
                            label: 'Attendance',
                            data: attData.map(d => d.count),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.08)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointBackgroundColor: '#8b5cf6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#f1f5f9' },
                                ticks: { font: { size: 11 } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 11 } }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Trends failed:', e);
            }
        }

        async function loadStudents() {
            try {
                const res = await fetch(`${API_BASE}/students`);
                students = await res.json();
                
                const tbody = document.getElementById('studentsTable');
                tbody.innerHTML = students.map(s => `
                    <tr>
                        <td class="font-medium">${s.full_name}</td>
                        <td class="mono text-enterprise-500">${s.phone_number || '—'}</td>
                        <td>${s.program_name || '—'}</td>
                        <td><span class="badge ${s.is_active ? 'badge-success' : 'badge-danger'}">${s.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button onclick="toggleUserStatus('${s.user_id}', ${!s.is_active})" class="action-link action-link-primary">${s.is_active ? 'Deactivate' : 'Activate'}</button>
                            <span class="text-enterprise-300 mx-2">|</span>
                            <button onclick="deleteUser('${s.user_id}')" class="action-link action-link-danger">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Load students failed:', e);
            }
        }

        async function loadTeachers() {
            try {
                const res = await fetch(`${API_BASE}/teachers`);
                teachers = await res.json();
                
                const tbody = document.getElementById('teachersTable');
                tbody.innerHTML = teachers.map(t => `
                    <tr>
                        <td class="font-medium">${t.full_name}</td>
                        <td>${t.program_name || '—'}</td>
                        <td><span class="badge ${t.is_active ? 'badge-success' : 'badge-danger'}">${t.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button onclick="toggleUserStatus('${t.user_id}', ${!t.is_active})" class="action-link action-link-primary">${t.is_active ? 'Deactivate' : 'Activate'}</button>
                            <span class="text-enterprise-300 mx-2">|</span>
                            <button onclick="deleteUser('${t.user_id}')" class="action-link action-link-danger">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Load teachers failed:', e);
            }
        }

        async function loadPrograms() {
            try {
                const res = await fetch(`${API_BASE}/programs`);
                programs = await res.json();
                
                const tbody = document.getElementById('programsTable');
                if (tbody) {
                    tbody.innerHTML = programs.map(p => `
                        <tr>
                            <td class="font-medium">${p.name}</td>
                            <td class="mono text-enterprise-500">${p.cost_center}</td>
                            <td>${p.default_daily_allowance} SAR</td>
                            <td>${p.student_count}</td>
                            <td>${p.teacher_count}</td>
                            <td><span class="badge ${p.is_active ? 'badge-success' : 'badge-danger'}">${p.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button onclick="deleteProgram('${p.program_id}')" class="action-link action-link-danger">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                console.error('Load programs failed:', e);
            }
        }

        function loadProgramSelects() {
            const selects = ['createUserProgram', 'bulkStudentProgram', 'bulkTeacherProgram', 'bulkAllowanceProgram'];
            const options = programs.map(p => `<option value="${p.program_id}">${p.name}</option>`).join('');
            selects.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<option value="">Select Program</option>' + options;
            });
        }

        async function loadStudentSelect() {
            if (students.length === 0) await loadStudents();
            const options = students.map(s => `<option value="${s.student_id}">${s.full_name}</option>`).join('');
            document.getElementById('allowanceStudent').innerHTML = '<option value="">Select Student</option>' + options;
        }

        async function loadAllowances() {
            const date = document.getElementById('allowanceDate').value;
            try {
                const url = date ? `${API_BASE}/allowances?filter_date=${date}` : `${API_BASE}/allowances`;
                const res = await fetch(url);
                const data = await res.json();
                
                const tbody = document.getElementById('allowancesTable');
                tbody.innerHTML = data.map(a => `
                    <tr>
                        <td class="font-medium">${a.full_name}</td>
                        <td>${a.date}</td>
                        <td>${a.base_amount} SAR</td>
                        <td>${a.bonus_amount} SAR</td>
                        <td class="font-semibold text-enterprise-900">${a.total_amount} SAR</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="text-center text-enterprise-500 py-8">No allowances found for the selected criteria</td></tr>';
            } catch (e) {
                showToast('Failed to load allowances', 'error');
            }
        }

        async function loadTelemetry() {
            try {
                const res = await fetch(`${API_BASE}/telemetry`);
                const data = await res.json();
                
                document.getElementById('pgTelemetry').innerHTML = `
                    <div class="flex justify-between py-2 border-b border-enterprise-100">
                        <span class="text-enterprise-600">Database Size</span>
                        <span class="font-medium text-enterprise-900">${data.postgres.database_size}</span>
                    </div>
                    <div class="pt-2">
                        <span class="text-enterprise-600 text-xs uppercase tracking-wide">Tables</span>
                        ${Object.entries(data.postgres.table_counts).map(([k,v]) => `
                            <div class="flex justify-between py-1.5 text-enterprise-600">
                                <span>${k}</span>
                                <span class="mono">${v} rows</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                document.getElementById('mongoTelemetry').innerHTML = `
                    <div class="flex justify-between py-2 border-b border-enterprise-100">
                        <span class="text-enterprise-600">Total Documents</span>
                        <span class="font-medium text-enterprise-900">${data.mongodb.total_documents}</span>
                    </div>
                    <div class="pt-2">
                        <span class="text-enterprise-600 text-xs uppercase tracking-wide">Collections</span>
                        ${Object.entries(data.mongodb.collections).map(([k,v]) => `
                            <div class="flex justify-between py-1.5 text-enterprise-600">
                                <span>${k}</span>
                                <span class="mono">${v}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                document.getElementById('redisTelemetry').innerHTML = `
                    <div class="flex justify-between py-2 border-b border-enterprise-100">
                        <span class="text-enterprise-600">Memory Usage</span>
                        <span class="font-medium text-enterprise-900">${data.redis.memory}</span>
                    </div>
                    <div class="flex justify-between py-2">
                        <span class="text-enterprise-600">Total Keys</span>
                        <span class="font-medium text-enterprise-900">${data.redis.keys}</span>
                    </div>
                `;
                
                document.getElementById('txTelemetry').innerHTML = `
                    <div class="grid grid-cols-3 gap-4">
                        <div class="telemetry-stat">
                            <div class="value">${data.transactions.today}</div>
                            <div class="label">Today</div>
                        </div>
                        <div class="telemetry-stat">
                            <div class="value">${data.transactions.week}</div>
                            <div class="label">This Week</div>
                        </div>
                        <div class="telemetry-stat">
                            <div class="value">${data.transactions.month}</div>
                            <div class="label">This Month</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('attTelemetry').innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="telemetry-stat">
                            <div class="value">${data.attendance.today}</div>
                            <div class="label">Today</div>
                        </div>
                        <div class="telemetry-stat">
                            <div class="value">${data.attendance.week}</div>
                            <div class="label">This Week</div>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('Telemetry failed:', e);
            }
        }

        function toggleUserFields(role) {
            document.getElementById('studentFields').classList.toggle('hidden', role !== 'student');
            document.getElementById('programSelectContainer').classList.toggle('hidden', role === 'store');
        }

        async function updateSupplementTargets() {
            const type = document.getElementById('supplementType').value;
            const targetSelect = document.getElementById('supplementTarget');
            
            if (type === 'student') {
                if (students.length === 0) await loadStudents();
                targetSelect.innerHTML = '<option value="">Select Student</option>' + 
                    students.map(s => `<option value="${s.student_id}">${s.full_name}</option>`).join('');
            } else {
                if (teachers.length === 0) await loadTeachers();
                targetSelect.innerHTML = '<option value="">Select Teacher</option>' + 
                    teachers.map(t => `<option value="${t.teacher_id}">${t.full_name}</option>`).join('');
            }
        }

        async function handleAddSupplement(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            
            try {
                const res = await fetch(`${API_BASE}/supplements`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    showToast(result.message || 'Supplement added successfully!', 'success');
                    e.target.reset();
                    document.getElementById('supplementDate').valueAsDate = new Date();
                } else {
                    showToast(result.detail || 'Failed to add supplement', 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function handleCreateUser(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form));
            
            try {
                const res = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    showToast('User created successfully!', 'success');
                    form.reset();
                    loadStudents();
                    loadTeachers();
                } else {
                    showToast(result.detail || 'Failed to create user', 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function toggleUserStatus(userId, isActive) {
            try {
                const res = await fetch(`${API_BASE}/users/${userId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: isActive })
                });
                if (res.ok) {
                    showToast('Status updated successfully', 'success');
                    loadStudents();
                    loadTeachers();
                }
            } catch (e) {
                showToast('Failed to update status', 'error');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
            try {
                const res = await fetch(`${API_BASE}/users/${userId}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('User deleted successfully', 'success');
                    loadStudents();
                    loadTeachers();
                }
            } catch (e) {
                showToast('Failed to delete user', 'error');
            }
        }

        async function handleBulkStudents(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            try {
                const res = await fetch(`${API_BASE}/bulk/students`, { method: 'POST', body: formData });
                const result = await res.json();
                
                document.getElementById('bulkStudentResult').innerHTML = `
                    <div class="info-box ${result.errors?.length > 0 ? 'info-box-warning' : 'info-box-success'}">
                        <i class="fas fa-check-circle mr-2"></i>
                        Successfully created ${result.created} students
                        ${result.errors?.length > 0 ? `<br><span class="text-amber-700 mt-1 block"><i class="fas fa-exclamation-triangle mr-1"></i> ${result.errors.length} errors occurred</span>` : ''}
                    </div>
                `;
                loadStudents();
            } catch (e) {
                document.getElementById('bulkStudentResult').innerHTML = `<div class="info-box info-box-warning"><i class="fas fa-times-circle mr-2"></i> Error: ${e.message}</div>`;
            }
        }

        async function handleBulkTeachers(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            try {
                const res = await fetch(`${API_BASE}/bulk/teachers`, { method: 'POST', body: formData });
                const result = await res.json();
                
                document.getElementById('bulkTeacherResult').innerHTML = `
                    <div class="info-box ${result.errors?.length > 0 ? 'info-box-warning' : 'info-box-success'}">
                        <i class="fas fa-check-circle mr-2"></i>
                        Successfully created ${result.created} teachers
                        ${result.errors?.length > 0 ? `<br><span class="text-amber-700 mt-1 block"><i class="fas fa-exclamation-triangle mr-1"></i> ${result.errors.length} errors occurred</span>` : ''}
                    </div>
                `;
                loadTeachers();
            } catch (e) {
                document.getElementById('bulkTeacherResult').innerHTML = `<div class="info-box info-box-warning"><i class="fas fa-times-circle mr-2"></i> Error: ${e.message}</div>`;
            }
        }

        async function handleSetAllowance(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            
            try {
                const res = await fetch(`${API_BASE}/allowances`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showToast('Allowance set successfully!', 'success');
                    e.target.reset();
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function handleBulkAllowance(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            
            try {
                const res = await fetch(`${API_BASE}/allowances/bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    showToast(`Allowances set for ${result.count} students!`, 'success');
                    e.target.reset();
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function handleCreateProgram(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            
            try {
                const res = await fetch(`${API_BASE}/programs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showToast('Program created successfully!', 'success');
                    e.target.reset();
                    loadPrograms();
                    loadProgramSelects();
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function deleteProgram(programId) {
            if (!confirm('Are you sure you want to delete this program? This action cannot be undone.')) return;
            try {
                const res = await fetch(`${API_BASE}/programs/${programId}`, { method: 'DELETE' });
                const result = await res.json();
                if (res.ok) {
                    showToast('Program deleted successfully', 'success');
                    loadPrograms();
                } else {
                    showToast(result.detail || 'Cannot delete program', 'error');
                }
            } catch (e) {
                showToast('Failed to delete program', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const bgColors = {
                success: 'bg-emerald-600',
                error: 'bg-red-600',
                info: 'bg-blue-600'
            };
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                info: 'fa-info-circle'
            };
            
            toast.className = `toast ${bgColors[type]} text-white px-5 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-80`;
            toast.innerHTML = `
                <i class="fas ${icons[type]}"></i>
                <span class="text-sm font-medium">${message}</span>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
    </script>
</body>
</html>
