<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy Admin Dashboard</title>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        enterprise: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617'
                        },
                        accent: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a'
                        },
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    },
                    fontFamily: {
                        sans: ['"IBM Plex Sans"', 'Inter', 'system-ui', 'sans-serif'],
                        mono: ['"IBM Plex Mono"', 'ui-monospace', 'SFMono-Regular']
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/dashboard.css">
    <script src="/static/vendor/chart.umd.min.js"></script>
    <style>
        /* Critical inline fallback styles */
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: #f8fafc; margin: 0; }
        .login-container { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-card { background: #fff; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-width: 400px; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: #fff; border: none; border-radius: 8px; padding: 12px 20px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.15s; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 8px 20px -8px rgba(37,99,235,0.5); }
        .btn-secondary { background: #fff; color: #334155; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 16px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }
        input, select, textarea { border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px 14px; font-size: 14px; width: 100%; box-sizing: border-box; transition: border-color 0.15s, box-shadow 0.15s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }
        input::placeholder { color: #94a3b8; }
        .card { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .sidebar { background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%); }
        .sidebar-item { padding: 12px 16px; margin: 4px 12px; border-radius: 8px; cursor: pointer; transition: all 0.15s; border-left: 3px solid transparent; }
        .sidebar-item:hover { background: rgba(255,255,255,0.08); }
        .sidebar-item.active { background: rgba(59,130,246,0.2); border-left-color: #3b82f6; }
        .sidebar-item.active i, .sidebar-item.active svg { color: #60a5fa; }
        .stat-card { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; }
        .health-dot { width: 10px; height: 10px; border-radius: 50%; }
        .health-healthy { background: #10b981; box-shadow: 0 0 0 3px rgba(16,185,129,0.2); }
        .health-unhealthy { background: #ef4444; box-shadow: 0 0 0 3px rgba(239,68,68,0.2); }
        .health-unknown { background: #94a3b8; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loading { width: 20px; height: 20px; border: 2px solid #e2e8f0; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 600; }
        .badge-success { background: rgba(16,185,129,0.12); color: #047857; }
        .badge-danger { background: rgba(239,68,68,0.12); color: #b91c1c; }
        .badge-info { background: rgba(59,130,246,0.12); color: #1d4ed8; }
        .badge-primary { background: rgba(99,102,241,0.12); color: #4338ca; }
        .tab-btn { padding: 12px 16px; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; transition: all 0.15s; }
        .tab-btn:hover { color: #1e293b; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 14px 16px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #475569; }
        td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #334155; }
        tr:hover td { background: #f8fafc; }
        .main-header { background: rgba(255,255,255,0.98); border-bottom: 1px solid #e2e8f0; backdrop-filter: blur(10px); }
        .toast { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .info-box { border-radius: 8px; padding: 12px 16px; font-size: 13px; display: flex; align-items: flex-start; gap: 8px; }
        .info-box-info { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }
        .info-box-warning { background: #fffbeb; border: 1px solid #fde68a; color: #92400e; }
        .info-box-success { background: #ecfdf5; border: 1px solid #a7f3d0; color: #065f46; }
        .action-link { font-size: 13px; font-weight: 600; background: none; border: none; cursor: pointer; padding: 0; }
        .action-link-primary { color: #2563eb; }
        .action-link-primary:hover { text-decoration: underline; }
        .action-link-danger { color: #dc2626; }
        .action-link-danger:hover { text-decoration: underline; }
        .service-card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; background: #fff; transition: all 0.15s; }
        .service-card:hover { border-color: #cbd5e1; }
        .service-card.healthy { border-left: 3px solid #10b981; }
        .service-card.unhealthy { border-left: 3px solid #ef4444; }
        .mono { font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace; }
        label { display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500; color: #374151; }
    </style>
</head>
<body style="background: #f8fafc; margin: 0;">
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card" style="padding: 48px 40px;">
            <div style="text-align: center; margin-bottom: 32px;">
                <img src="/static/assets/KAUSTAcademylogo.png" alt="KAUST Academy" style="max-width: 200px; height: auto; margin-bottom: 16px; display: block; margin-left: auto; margin-right: auto;">
                <p style="font-size: 16px; font-weight: 500; color: #374151; margin: 0;">Admin Login</p>
            </div>
            <form id="loginForm">
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Email</label>
                    <input type="email" id="loginEmail" placeholder="email" required style="margin-top: 6px;">
                </div>
                <div style="margin-bottom: 24px;">
                    <label style="font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Password</label>
                    <input type="password" id="loginPassword" placeholder="password" required style="margin-top: 6px;">
                </div>
                <div id="loginError" class="hidden" style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin-bottom: 16px; color: #dc2626; font-size: 14px;"></div>
                <button type="submit" class="btn-primary" style="font-size: 15px; padding: 14px 20px;">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden">
        <!-- Sidebar -->
        <div class="fixed left-0 top-0 h-full w-64 sidebar text-white z-50" style="display: flex; flex-direction: column;">
            <div style="padding: 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; justify-content: center;">
                    <img src="/static/assets/KAUSTAcademyWhite.png" alt="KAUST Academy" style="height: 68px; width: auto;">
                </div>
            </div>
            <nav style="flex: 1; padding: 16px 0; overflow-y: auto;">
                <div style="padding: 8px 20px; margin-bottom: 4px;">
                    <span style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; font-weight: 600;">Navigation</span>
                </div>
                <div class="sidebar-item active" data-page="dashboard">
                    <i class="fa-solid fa-gauge-high" style="width: 20px; color: #94a3b8;"></i>
                    <span style="margin-left: 12px; font-size: 14px; font-weight: 500;">Dashboard</span>
                </div>
                <div class="sidebar-item" data-page="users">
                    <i class="fa-solid fa-users" style="width: 20px; color: #94a3b8;"></i>
                    <span style="margin-left: 12px; font-size: 14px; font-weight: 500;">User Management</span>
                </div>
                <div class="sidebar-item" data-page="bulk">
                    <i class="fa-solid fa-cloud-arrow-up" style="width: 20px; color: #94a3b8;"></i>
                    <span style="margin-left: 12px; font-size: 14px; font-weight: 500;">Bulk Upload</span>
                </div>
                <div class="sidebar-item" data-page="allowances">
                    <i class="fa-solid fa-wallet" style="width: 20px; color: #94a3b8;"></i>
                    <span style="margin-left: 12px; font-size: 14px; font-weight: 500;">Allowances</span>
                </div>
                <div class="sidebar-item" data-page="programs">
                    <i class="fa-solid fa-sitemap" style="width: 20px; color: #94a3b8;"></i>
                    <span style="margin-left: 12px; font-size: 14px; font-weight: 500;">Programs</span>
                </div>
                <div class="sidebar-item" data-page="telemetry">
                    <i class="fa-solid fa-chart-line" style="width: 20px; color: #94a3b8;"></i>
                    <span style="margin-left: 12px; font-size: 14px; font-weight: 500;">Telemetry</span>
                </div>
            </nav>
            <div style="padding: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button id="logoutBtn" style="width: 100%; background: rgba(255,255,255,0.05); border: none; padding: 12px; border-radius: 8px; color: #cbd5e1; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.15s;">
                    <i class="fa-solid fa-right-from-bracket"></i> Sign Out
                </button>
                <button id="aboutBtn" onclick="showPage('about')" style="width: 100%; background: transparent; border: none; padding: 8px; border-radius: 6px; color: #64748b; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 8px; transition: color 0.15s;">
                    <i class="fa-solid fa-circle-info" style="font-size: 11px;"></i> About
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div style="margin-left: 256px; min-height: 100vh; background: #f8fafc;">
            <!-- Header -->
            <header class="main-header" style="padding: 16px 32px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 40;">
                <div>
                    <h2 id="pageTitle" style="font-size: 20px; font-weight: 600; color: #0f172a; margin: 0;">Dashboard</h2>
                    <p id="pageBreadcrumb" style="font-size: 13px; color: #64748b; margin: 4px 0 0 0;">Overview & Analytics</p>
                </div>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div id="healthIndicator" style="display: flex; align-items: center; gap: 10px; background: #f1f5f9; padding: 10px 16px; border-radius: 8px; font-size: 13px;">
                        <div class="health-dot health-unknown"></div>
                        <span style="color: #475569; font-weight: 500;">Checking status...</span>
                    </div>
                    <button onclick="location.reload()" class="btn-secondary" style="display: flex; align-items: center; gap: 8px;">
                        <i class="fa-solid fa-rotate-right" style="font-size: 12px;"></i> Refresh
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <main style="padding: 24px 32px; max-width: 1400px;">
                <!-- Dashboard Page -->
                <div id="page-dashboard" class="page-content">
                    <!-- Stats Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 28px;">
                        <div class="stat-card" style="padding: 24px; color: #fff;">
                            <div style="display: flex; align-items: flex-start; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 13px; color: #94a3b8; font-weight: 500; margin-bottom: 8px;">Total Students</div>
                                    <div style="font-size: 32px; font-weight: 700;" id="statStudents">—</div>
                                </div>
                                <div style="width: 48px; height: 48px; background: rgba(59,130,246,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa-solid fa-user-graduate" style="color: #60a5fa; font-size: 20px;"></i>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card" style="padding: 24px; color: #fff;">
                            <div style="display: flex; align-items: flex-start; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 13px; color: #94a3b8; font-weight: 500; margin-bottom: 8px;">Total Teachers</div>
                                    <div style="font-size: 32px; font-weight: 700;" id="statTeachers">—</div>
                                </div>
                                <div style="width: 48px; height: 48px; background: rgba(16,185,129,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa-solid fa-chalkboard-user" style="color: #34d399; font-size: 20px;"></i>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card" style="padding: 24px; color: #fff;">
                            <div style="display: flex; align-items: flex-start; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 13px; color: #94a3b8; font-weight: 500; margin-bottom: 8px;">Transactions Today</div>
                                    <div style="font-size: 32px; font-weight: 700;" id="statTransactions">—</div>
                                </div>
                                <div style="width: 48px; height: 48px; background: rgba(251,191,36,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa-solid fa-receipt" style="color: #fbbf24; font-size: 20px;"></i>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card" style="padding: 24px; color: #fff;">
                            <div style="display: flex; align-items: flex-start; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 13px; color: #94a3b8; font-weight: 500; margin-bottom: 8px;">Attendance Today</div>
                                    <div style="font-size: 32px; font-weight: 700;" id="statAttendance">—</div>
                                </div>
                                <div style="width: 48px; height: 48px; background: rgba(168,85,247,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa-solid fa-clipboard-check" style="color: #a855f7; font-size: 20px;"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Service Health -->
                    <div class="card" style="padding: 24px; margin-bottom: 28px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                            <div>
                                <h3 style="font-size: 16px; font-weight: 600; color: #0f172a; margin: 0;">Service Health</h3>
                                <p style="font-size: 13px; color: #64748b; margin: 4px 0 0 0;">Real-time infrastructure status</p>
                            </div>
                            <span class="badge badge-success">
                                <i class="fa-solid fa-circle" style="font-size: 6px; margin-right: 6px;"></i> Monitoring Active
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px;" id="serviceHealth">
                            <div class="service-card" id="pgServiceCard">
                                <div style="display: flex; align-items: center; gap: 14px;">
                                    <div style="width: 44px; height: 44px; background: #eff6ff; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fa-solid fa-database" style="color: #2563eb; font-size: 18px;"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #0f172a; font-size: 14px;">PostgreSQL</div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                            <div class="health-dot health-unknown" id="pgHealth"></div>
                                            <span style="font-size: 12px; color: #64748b;" id="pgStatus">Checking...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="service-card" id="mongoServiceCard">
                                <div style="display: flex; align-items: center; gap: 14px;">
                                    <div style="width: 44px; height: 44px; background: #ecfdf5; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fa-solid fa-leaf" style="color: #059669; font-size: 18px;"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #0f172a; font-size: 14px;">MongoDB</div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                            <div class="health-dot health-unknown" id="mongoHealth"></div>
                                            <span style="font-size: 12px; color: #64748b;" id="mongoStatus">Checking...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="service-card" id="redisServiceCard">
                                <div style="display: flex; align-items: center; gap: 14px;">
                                    <div style="width: 44px; height: 44px; background: #fef2f2; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fa-solid fa-bolt" style="color: #dc2626; font-size: 18px;"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #0f172a; font-size: 14px;">Redis</div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                            <div class="health-dot health-unknown" id="redisHealth"></div>
                                            <span style="font-size: 12px; color: #64748b;" id="redisStatus">Checking...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                        <div class="card">
                            <div style="padding: 20px 24px; border-bottom: 1px solid #e2e8f0;">
                                <h3 style="font-size: 15px; font-weight: 600; color: #0f172a; margin: 0;">Transaction Trend</h3>
                                <p style="font-size: 13px; color: #64748b; margin: 4px 0 0 0;">Last 7 days</p>
                            </div>
                            <div style="padding: 20px 24px;">
                                <canvas id="transactionChart" height="200"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <div style="padding: 20px 24px; border-bottom: 1px solid #e2e8f0;">
                                <h3 style="font-size: 15px; font-weight: 600; color: #0f172a; margin: 0;">Attendance Trend</h3>
                                <p style="font-size: 13px; color: #64748b; margin: 4px 0 0 0;">Last 7 days</p>
                            </div>
                            <div style="padding: 20px 24px;">
                                <canvas id="attendanceChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Page -->
                <div id="page-users" class="page-content hidden">
                    <div style="display: flex; gap: 0; margin-bottom: 24px; border-bottom: 1px solid #e2e8f0;">
                        <button class="tab-btn active" data-tab="students">Students</button>
                        <button class="tab-btn" data-tab="teachers">Teachers</button>
                        <button class="tab-btn" data-tab="create">Create User</button>
                    </div>
                    
                    <div id="tab-students" class="tab-content">
                        <div class="card">
                            <div style="padding: 16px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                                <div style="position: relative;">
                                    <i class="fa-solid fa-search" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 14px;"></i>
                                    <input type="text" id="searchStudents" placeholder="Search students..." style="padding-left: 40px; width: 280px;">
                                </div>
                                <button onclick="loadStudents()" class="btn-secondary" style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fa-solid fa-rotate-right" style="font-size: 12px;"></i> Refresh
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table>
                                    <thead><tr><th>Name</th><th>Phone Number</th><th>Program</th><th>Status</th><th>Actions</th></tr></thead>
                                    <tbody id="studentsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-teachers" class="tab-content hidden">
                        <div class="card">
                            <div style="padding: 16px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                                <div style="position: relative;">
                                    <i class="fa-solid fa-search" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 14px;"></i>
                                    <input type="text" id="searchTeachers" placeholder="Search teachers..." style="padding-left: 40px; width: 280px;">
                                </div>
                                <button onclick="loadTeachers()" class="btn-secondary" style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fa-solid fa-rotate-right" style="font-size: 12px;"></i> Refresh
                                </button>
                            </div>
                            <div style="overflow-x: auto;">
                                <table>
                                    <thead><tr><th>Name</th><th>Program</th><th>Status</th><th>Actions</th></tr></thead>
                                    <tbody id="teachersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-create" class="tab-content hidden">
                        <div class="card" style="padding: 32px; max-width: 640px;">
                            <div style="margin-bottom: 24px;">
                                <h3 style="font-size: 16px; font-weight: 600; color: #0f172a; margin: 0;">Create New User</h3>
                                <p style="font-size: 13px; color: #64748b; margin: 6px 0 0 0;">Add a new user to the system</p>
                            </div>
                            <form id="createUserForm">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label>Full Name <span style="color: #dc2626;">*</span></label>
                                        <input type="text" name="full_name" required>
                                    </div>
                                    <div>
                                        <label>Email <span style="color: #dc2626;">*</span></label>
                                        <input type="email" name="email" required>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label>Role <span style="color: #dc2626;">*</span></label>
                                        <select name="role" required onchange="toggleUserFields(this.value)">
                                            <option value="student">Student</option>
                                            <option value="teacher">Teacher</option>
                                            <option value="store">Store Staff</option>
                                        </select>
                                    </div>
                                    <div id="programSelectContainer">
                                        <label>Program <span id="programRequiredStar" style="color: #dc2626;">*</span></label>
                                        <select name="program_id" id="createUserProgram" onchange="loadClassesForProgram(this.value, 'createUserClass')"></select>
                                    </div>
                                </div>
                                <div id="teacherProgramsContainer" class="hidden" style="margin-bottom: 20px;">
                                    <label>Programs <span style="font-weight: normal; color: #64748b;">(Teachers can be assigned to multiple programs)</span></label>
                                    <select name="program_ids" id="createUserProgramsMulti" multiple style="min-height: 100px;"></select>
                                    <p style="font-size: 12px; color: #64748b; margin-top: 6px;">Hold Ctrl/Cmd to select multiple programs</p>
                                </div>
                                <div id="classSelectContainer" style="margin-bottom: 20px;">
                                    <label>Class <span style="font-weight: normal; color: #64748b;">(Required for attendance)</span></label>
                                    <select name="class_id" id="createUserClass">
                                        <option value="">Select Class (optional)</option>
                                    </select>
                                    <p style="font-size: 12px; color: #64748b; margin-top: 6px;">Students must be enrolled in a class to receive attendance QR codes</p>
                                </div>
                                <div id="studentFields" style="margin-bottom: 20px;">
                                    <label>Phone Number</label>
                                    <input type="text" name="phone_number" placeholder="+966501234567">
                                    <p style="font-size: 12px; color: #64748b; margin-top: 6px;">Saudi format: +966 followed by 9 digits, or 05XXXXXXXX</p>
                                </div>
                                <div style="margin-bottom: 24px;">
                                    <label>Password</label>
                                    <input type="password" name="password" placeholder="Leave blank for default (temp123)">
                                </div>
                                <div>
                                    <button type="submit" class="btn-primary">Create User</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Bulk Upload Page -->
                <div id="page-bulk" class="page-content hidden">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
                        <div class="card" style="padding: 24px;">
                            <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 24px;">
                                <div style="width: 44px; height: 44px; background: #eff6ff; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa-solid fa-user-graduate" style="color: #2563eb; font-size: 18px;"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 15px; font-weight: 600; color: #0f172a; margin: 0;">Bulk Upload Students</h3>
                                    <p style="font-size: 13px; color: #64748b; margin: 4px 0 0 0;">Import multiple students via CSV</p>
                                </div>
                            </div>
                            <form id="bulkStudentForm">
                                <div style="margin-bottom: 16px;">
                                    <label>Program <span style="color: #dc2626;">*</span></label>
                                    <select name="program_id" required id="bulkStudentProgram" onchange="loadBulkStudentClasses()"></select>
                                </div>
                                <div style="margin-bottom: 16px;" id="bulkStudentClassContainer">
                                    <label>Class <span style="font-weight: normal; color: #64748b;">(Enroll all students in this class)</span></label>
                                    <select name="class_id" id="bulkStudentClass">
                                        <option value="">No class enrollment</option>
                                    </select>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label>CSV File <span style="color: #dc2626;">*</span></label>
                                    <input type="file" name="file" accept=".csv" required>
                                </div>
                                <div class="info-box info-box-info" style="margin-bottom: 16px;">
                                    <i class="fa-solid fa-circle-info" style="margin-top: 2px;"></i>
                                    <span>Required columns: <code class="mono" style="background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 4px; font-size: 12px;">full_name, email, phone_number</code>. Optional: <code class="mono" style="background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 4px; font-size: 12px;">class_id</code></span>
                                </div>
                                <button type="submit" class="btn-primary">Upload Students</button>
                            </form>
                            <div id="bulkStudentResult" style="margin-top: 16px;"></div>
                        </div>
                        
                        <div class="card" style="padding: 24px;">
                            <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 24px;">
                                <div style="width: 44px; height: 44px; background: #ecfdf5; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa-solid fa-chalkboard-user" style="color: #059669; font-size: 18px;"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 15px; font-weight: 600; color: #0f172a; margin: 0;">Bulk Upload Teachers</h3>
                                    <p style="font-size: 13px; color: #64748b; margin: 4px 0 0 0;">Import multiple teachers via CSV</p>
                                </div>
                            </div>
                            <form id="bulkTeacherForm">
                                <div style="margin-bottom: 16px;">
                                    <label>Program <span style="color: #dc2626;">*</span></label>
                                    <select name="program_id" required id="bulkTeacherProgram"></select>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label>CSV File <span style="color: #dc2626;">*</span></label>
                                    <input type="file" name="file" accept=".csv" required>
                                </div>
                                <div class="info-box info-box-info" style="margin-bottom: 16px;">
                                    <i class="fa-solid fa-circle-info" style="margin-top: 2px;"></i>
                                    <span>Required columns: <code class="mono" style="background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 4px; font-size: 12px;">full_name, email</code></span>
                                </div>
                                <button type="submit" class="btn-primary">Upload Teachers</button>
                            </form>
                            <div id="bulkTeacherResult" style="margin-top: 16px;"></div>
                        </div>
                    </div>
                    
                    <div class="card" style="padding: 24px; margin-top: 24px;">
                        <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 24px;">
                            <div style="width: 44px; height: 44px; background: #f1f5f9; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                <i class="fa-solid fa-file-csv" style="color: #475569; font-size: 18px;"></i>
                            </div>
                            <div>
                                <h3 style="font-size: 15px; font-weight: 600; color: #0f172a; margin: 0;">CSV Format Reference</h3>
                                <p style="font-size: 13px; color: #64748b; margin: 4px 0 0 0;">Template examples for bulk uploads</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <h4 style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0 0 12px 0;">Student CSV Template</h4>
                                <pre class="mono" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 16px; border-radius: 8px; font-size: 13px; overflow-x: auto; margin: 0;">full_name,email,phone_number
Ahmed Mohammed,ahmed@academy.edu,+966501234567
Sara Abdullah,sara@academy.edu,+966501234568</pre>
                            </div>
                            <div>
                                <h4 style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0 0 12px 0;">Teacher CSV Template</h4>
                                <pre class="mono" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 16px; border-radius: 8px; font-size: 13px; overflow-x: auto; margin: 0;">full_name,email
Dr. Khalid Ibrahim,khalid@academy.edu
Dr. Fatima Al-Saud,fatima@academy.edu</pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Allowances Page -->
                <div id="page-allowances" class="page-content hidden">
                    <div style="display: flex; gap: 0; margin-bottom: 24px; border-bottom: 1px solid #e2e8f0;">
                        <button class="tab-btn active" data-tab="viewAllowances">View Allowances</button>
                        <button class="tab-btn" data-tab="setAllowance">Set Individual</button>
                        <button class="tab-btn" data-tab="bulkAllowance">Bulk Set</button>
                        <button class="tab-btn" data-tab="addSupplement">Add Supplement</button>
                    </div>
                    
                    <div id="tab-viewAllowances" class="tab-content">
                        <div class="card">
                            <div class="p-4 border-b border-enterprise-100 flex items-center gap-4 flex-wrap">
                                <label class="text-sm font-medium text-enterprise-700">Filter by Date:</label>
                                <input type="date" id="allowanceDate" class="w-48">
                                <label class="text-sm font-medium text-enterprise-700 ml-4">User Type:</label>
                                <select id="allowanceUserType" class="w-36">
                                    <option value="">All Users</option>
                                    <option value="student">Students</option>
                                    <option value="teacher">Teachers</option>
                                </select>
                                <button onclick="loadAllowances()" class="btn-primary">Load Allowances</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table>
                                    <thead><tr><th>Name</th><th>Type</th><th>Date</th><th>Base Amount</th><th>Supplement</th><th>Total</th></tr></thead>
                                    <tbody id="allowancesTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-setAllowance" class="tab-content hidden">
                        <div class="card p-8 max-w-lg">
                            <div class="mb-6">
                                <h3 class="font-semibold text-enterprise-900">Set Individual Allowance</h3>
                                <p class="text-sm text-enterprise-500">Configure allowance for a specific student</p>
                            </div>
                            <form id="setAllowanceForm" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Student <span class="text-danger">*</span></label>
                                    <select name="student_id" required class="w-full" id="allowanceStudent"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Date <span class="text-danger">*</span></label>
                                    <input type="date" name="date" required class="w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Base Amount (SAR)</label>
                                    <input type="number" name="base_amount" value="50" step="0.01" class="w-full">
                                </div>
                                <button type="submit" class="btn-primary">Set Allowance</button>
                            </form>
                        </div>
                    </div>
                    
                    <div id="tab-bulkAllowance" class="tab-content hidden">
                        <div class="card p-8 max-w-lg">
                            <div class="mb-6">
                                <h3 class="font-semibold text-enterprise-900">Bulk Set by Program</h3>
                                <p class="text-sm text-enterprise-500">Set allowances for all students in a program</p>
                            </div>
                            <form id="bulkAllowanceForm" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Program <span class="text-danger">*</span></label>
                                    <select name="program_id" required class="w-full" id="bulkAllowanceProgram"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Date <span class="text-danger">*</span></label>
                                    <input type="date" name="date" required class="w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Base Amount (SAR)</label>
                                    <input type="number" name="base_amount" value="50" step="0.01" class="w-full">
                                </div>
                                <div class="info-box info-box-warning">
                                    <i class="fa-solid fa-triangle-exclamation" style="margin-top: 2px;"></i>
                                    <span>This will set allowances for <strong>all active students</strong> in the selected program.</span>
                                </div>
                                <button type="submit" class="btn-primary">Set Bulk Allowances</button>
                            </form>
                        </div>
                    </div>
                    
                    <div id="tab-addSupplement" class="tab-content hidden">
                        <div class="card p-8 max-w-lg">
                            <div class="mb-6">
                                <h3 class="font-semibold text-enterprise-900">Add Supplement</h3>
                                <p class="text-sm text-enterprise-500">Add a supplement amount to an existing allowance</p>
                            </div>
                            <form id="addSupplementForm" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Recipient Type <span class="text-danger">*</span></label>
                                    <select name="type" required class="w-full" id="supplementType" onchange="updateSupplementTargets()">
                                        <option value="student">Student</option>
                                        <option value="teacher">Teacher</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Select Recipient <span class="text-danger">*</span></label>
                                    <select name="target_id" required class="w-full" id="supplementTarget"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Date</label>
                                    <input type="date" name="date" class="w-full" id="supplementDate">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Supplement Amount (SAR) <span class="text-danger">*</span></label>
                                    <input type="number" name="amount" required step="0.01" class="w-full" placeholder="e.g., 25.00">
                                </div>
                                <div class="info-box info-box-success">
                                    <i class="fa-solid fa-circle-info" style="margin-top: 2px;"></i>
                                    <span>This amount will be added to the recipient's existing allowance for the selected date.</span>
                                </div>
                                <button type="submit" class="btn-primary">Add Supplement</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Programs Page -->
                <div id="page-programs" class="page-content hidden">
                    <div class="flex gap-1 mb-6 border-b border-enterprise-200">
                        <button class="tab-btn active" data-tab="viewPrograms">All Programs</button>
                        <button class="tab-btn" data-tab="createProgram">Create Program</button>
                        <button class="tab-btn" data-tab="manageClasses">Manage Classes</button>
                    </div>
                    
                    <div id="tab-viewPrograms" class="tab-content">
                        <div class="card">
                            <div class="p-4 border-b border-enterprise-100 flex justify-between items-center">
                                <span class="font-medium text-enterprise-800">Programs / Cost Centers</span>
                                <button onclick="loadPrograms()" class="btn-secondary" style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fa-solid fa-rotate-right" style="font-size: 12px;"></i> Refresh
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table>
                                    <thead><tr><th>Name</th><th>Cost Center</th><th>Default Allowance</th><th>Students</th><th>Teachers</th><th>Status</th><th>Actions</th></tr></thead>
                                    <tbody id="programsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-createProgram" class="tab-content hidden">
                        <div class="card p-8 max-w-lg">
                            <div class="mb-6">
                                <h3 class="font-semibold text-enterprise-900">Create New Program</h3>
                                <p class="text-sm text-enterprise-500">Add a new program or cost center</p>
                            </div>
                            <form id="createProgramForm" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Program Name <span class="text-danger">*</span></label>
                                    <input type="text" name="name" required class="w-full" placeholder="e.g., Computer Science 2024">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Cost Center Code <span class="text-danger">*</span></label>
                                    <input type="text" name="cost_center" required class="w-full" placeholder="e.g., CC-CS-2024">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-enterprise-700 mb-2">Default Daily Allowance (SAR)</label>
                                    <input type="number" name="default_daily_allowance" value="50" step="0.01" class="w-full">
                                </div>
                                <button type="submit" class="btn-primary">Create Program</button>
                            </form>
                        </div>
                    </div>

                    <div id="tab-manageClasses" class="tab-content hidden">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <!-- Classes List -->
                            <div class="card">
                                <div class="p-4 border-b border-enterprise-100 flex justify-between items-center">
                                    <span class="font-medium text-enterprise-800">Classes</span>
                                    <button onclick="loadClasses()" class="btn-secondary" style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fa-solid fa-rotate-right" style="font-size: 12px;"></i> Refresh
                                    </button>
                                </div>
                                <div class="p-4">
                                    <div style="margin-bottom: 16px;">
                                        <label class="block text-sm font-medium text-enterprise-700 mb-2">Filter by Program</label>
                                        <select id="classFilterProgram" onchange="loadClasses()" class="w-full">
                                            <option value="">All Programs</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="overflow-x-auto">
                                    <table>
                                        <thead><tr><th>Class Name</th><th>Program</th><th>Teacher</th><th>Status</th><th>Actions</th></tr></thead>
                                        <tbody id="classesTable"></tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Create Class Form -->
                            <div class="card p-6">
                                <div class="mb-6">
                                    <h3 class="font-semibold text-enterprise-900">Create New Class</h3>
                                    <p class="text-sm text-enterprise-500">Add a class under a program</p>
                                </div>
                                <form id="createClassForm" class="space-y-5">
                                    <div>
                                        <label class="block text-sm font-medium text-enterprise-700 mb-2">Class Name <span class="text-danger">*</span></label>
                                        <input type="text" name="name" required class="w-full" placeholder="e.g., Section A - Morning">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-enterprise-700 mb-2">Program <span class="text-danger">*</span></label>
                                        <select name="program_id" required class="w-full" id="classFormProgram">
                                            <option value="">Select Program</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-enterprise-700 mb-2">Teacher <span class="text-danger">*</span></label>
                                        <select name="teacher_id" required class="w-full" id="classFormTeacher">
                                            <option value="">Select Teacher</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn-primary">Create Class</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Telemetry Page -->
                <div id="page-telemetry" class="page-content hidden">
                    <!-- PostgreSQL - Wide card at top -->
                    <div class="card p-6 mb-6">
                        <div class="flex items-center gap-3 mb-5">
                            <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center">
                                <i class="fa-solid fa-database text-blue-600"></i>
                            </div>
                            <h3 class="font-semibold text-enterprise-900">PostgreSQL Database</h3>
                        </div>
                        <div id="pgTelemetry" style="display: grid; grid-template-columns: auto 1fr; gap: 16px; align-items: start;">
                            <div class="loading"></div>
                        </div>
                    </div>
                    
                    <!-- MongoDB and Redis - 2 column grid below -->
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div class="card p-6">
                            <div class="flex items-center gap-3 mb-5">
                                <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center">
                                    <i class="fa-solid fa-leaf text-green-600"></i>
                                </div>
                                <h3 class="font-semibold text-enterprise-900">MongoDB</h3>
                            </div>
                            <div class="space-y-2 text-sm" id="mongoTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center gap-3 mb-5">
                                <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center">
                                    <i class="fa-solid fa-bolt text-red-600"></i>
                                </div>
                                <h3 class="font-semibold text-enterprise-900">Redis</h3>
                            </div>
                            <div class="space-y-2 text-sm" id="redisTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div class="card p-6">
                            <div class="flex items-center gap-3 mb-5">
                                <div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center">
                                    <i class="fa-solid fa-file-invoice-dollar text-purple-600"></i>
                                </div>
                                <h3 class="font-semibold text-enterprise-900">Transactions</h3>
                            </div>
                            <div class="space-y-2" id="txTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center gap-3 mb-5">
                                <div class="w-10 h-10 rounded-lg bg-teal-50 flex items-center justify-center">
                                    <i class="fa-solid fa-clipboard-check text-teal-600"></i>
                                </div>
                                <h3 class="font-semibold text-enterprise-900">Attendance</h3>
                            </div>
                            <div class="space-y-2" id="attTelemetry">
                                <div class="loading"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- About Page -->
                <div id="page-about" class="page-content hidden">
                    <div class="card" style="padding: 48px; max-width: 800px; margin: 0 auto; background-color: #585858;">
                        <div style="display: flex; align-items: flex-start; gap: 40px;">
                            <div style="flex-shrink: 0; max-width: 25%;">
                                <img src="/static/assets/logo.png" alt="Rikoukei Labs" style="width: 100%; height: auto;">
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                <h2 style="font-size: 28px; font-weight: 700; color: #ffffff; margin: 0 0 4px 0;">Rikoukei Labs</h2>
                                <p style="font-size: 16px; font-style: italic; color: #ffffff; margin: 0 0 24px 0;">Scientific Software Solutions</p>
                                <div style="font-size: 14px; color: #ffffff; line-height: 1.8;">
                                    <p style="margin: 0 0 8px 0;">
                                        <i class="fa-solid fa-globe" style="width: 18px; color: #ffffff;"></i>
                                        <a href="https://www.rikoukeilabs.com" target="_blank" style="color: #ffffff; text-decoration: none;">www.rikoukeilabs.com</a>
                                    </p>
                                    <p style="margin: 0 0 8px 0;">
                                        <i class="fa-solid fa-user" style="width: 18px; color: #ffffff;"></i>
                                        <span>Contact - Sam Victor, Principal Architect</span>
                                    </p>
                                    <p style="margin: 0;">
                                        <i class="fa-solid fa-envelope" style="width: 18px; color: #ffffff;"></i>
                                        <a href="mailto:sam.victor@rikoukeilabs.com" style="color: #ffffff; text-decoration: none;">sam.victor@rikoukeilabs.com</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 40px; padding-top: 24px; border-top: 1px solid #e2e8f0; text-align: center;">
                            <p style="font-size: 12px; color: #ffffff; margin: 0;">© 2026, Rikoukei Labs FZ-LLC, All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-3"></div>

    <script>
        const API_BASE = '/dashboard/api';
        let authToken = localStorage.getItem('adminToken');
        let programs = [];
        let students = [];
        let teachers = [];
        let transactionChart = null;
        let attendanceChart = null;

        // Chart.js default configuration
        Chart.defaults.font.family = "'IBM Plex Sans', sans-serif";
        Chart.defaults.color = '#64748b';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken) {
                verifySession();
            }
            setupEventListeners();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Sidebar navigation
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', () => navigateTo(item.dataset.page));
            });
            
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabGroup = e.target.closest('.page-content');
                    tabGroup.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    tabGroup.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    e.target.classList.add('active');
                    document.getElementById('tab-' + e.target.dataset.tab).classList.remove('hidden');
                });
            });
            
            // Forms
            document.getElementById('createUserForm').addEventListener('submit', handleCreateUser);
            document.getElementById('bulkStudentForm').addEventListener('submit', handleBulkStudents);
            document.getElementById('bulkTeacherForm').addEventListener('submit', handleBulkTeachers);
            document.getElementById('setAllowanceForm').addEventListener('submit', handleSetAllowance);
            document.getElementById('bulkAllowanceForm').addEventListener('submit', handleBulkAllowance);
            document.getElementById('createProgramForm').addEventListener('submit', handleCreateProgram);
            document.getElementById('addSupplementForm').addEventListener('submit', handleAddSupplement);
            document.getElementById('createClassForm').addEventListener('submit', handleCreateClass);
            
            // Set default date for supplement
            document.getElementById('supplementDate').valueAsDate = new Date();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    document.getElementById('adminName').textContent = data.full_name;
                    showDashboard();
                    loadDashboardData();
                } else {
                    document.getElementById('loginError').textContent = 'Invalid credentials. Please try again.';
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('loginError').textContent = 'Connection failed. Please check your network.';
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        async function verifySession() {
            try {
                const res = await fetch(`${API_BASE}/auth/verify?token=${authToken}`);
                const data = await res.json();
                if (data.valid) {
                    showDashboard();
                    loadDashboardData();
                } else {
                    localStorage.removeItem('adminToken');
                    authToken = null;
                }
            } catch {
                localStorage.removeItem('adminToken');
                authToken = null;
            }
        }

        function handleLogout() {
            localStorage.removeItem('adminToken');
            authToken = null;
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
        }

        const pageBreadcrumbs = {
            dashboard: 'Overview & Analytics',
            users: 'Manage Students & Teachers',
            bulk: 'Import Data via CSV',
            allowances: 'Financial Management',
            programs: 'Cost Centers & Programs',
            telemetry: 'System Monitoring',
            about: 'Developer Information'
        };

        function showPage(page) {
            // For non-sidebar pages like About
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            
            const titles = { about: 'About' };
            document.getElementById('pageTitle').textContent = titles[page] || page;
            document.getElementById('pageBreadcrumb').textContent = pageBreadcrumbs[page] || '';
        }

        function navigateTo(page) {
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            
            const titles = { dashboard: 'Dashboard', users: 'User Management', bulk: 'Bulk Upload', allowances: 'Allowances', programs: 'Programs', telemetry: 'Telemetry' };
            document.getElementById('pageTitle').textContent = titles[page] || page;
            document.getElementById('pageBreadcrumb').textContent = pageBreadcrumbs[page] || '';
            
            if (page === 'users') { loadStudents(); loadTeachers(); loadPrograms().then(() => loadProgramSelects()); }
            if (page === 'bulk') { loadPrograms().then(() => loadProgramSelects()); }
            if (page === 'allowances') { loadStudentSelect(); loadPrograms().then(() => loadProgramSelects()); updateSupplementTargets(); }
            if (page === 'programs') { 
                loadPrograms().then(() => {
                    loadTeachers().then(() => loadClassFormSelects());
                });
                loadClasses();
            }
            if (page === 'telemetry') { loadTelemetry(); }
        }

        async function loadDashboardData() {
            await loadHealth();
            await loadStats();
            await loadTrends();
            await loadPrograms();
        }

        async function loadHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                
                updateHealthDot('pgHealth', data.postgres.connected);
                updateHealthDot('mongoHealth', data.mongodb.connected);
                updateHealthDot('redisHealth', data.redis.connected);
                
                // Update service cards
                document.getElementById('pgServiceCard').classList.toggle('healthy', data.postgres.connected);
                document.getElementById('pgServiceCard').classList.toggle('unhealthy', !data.postgres.connected);
                document.getElementById('mongoServiceCard').classList.toggle('healthy', data.mongodb.connected);
                document.getElementById('mongoServiceCard').classList.toggle('unhealthy', !data.mongodb.connected);
                document.getElementById('redisServiceCard').classList.toggle('healthy', data.redis.connected);
                document.getElementById('redisServiceCard').classList.toggle('unhealthy', !data.redis.connected);
                
                document.getElementById('pgStatus').textContent = data.postgres.connected ? 'Connected' : 'Disconnected';
                document.getElementById('mongoStatus').textContent = data.mongodb.connected ? 'Connected' : 'Disconnected';
                document.getElementById('redisStatus').textContent = data.redis.connected ? 'Connected' : 'Disconnected';
                
                const indicator = document.getElementById('healthIndicator');
                indicator.querySelector('.health-dot').className = `health-dot health-${data.overall === 'healthy' ? 'healthy' : 'unhealthy'}`;
                indicator.querySelector('span').textContent = data.overall === 'healthy' ? 'All Systems Operational' : 'System Degraded';
            } catch (e) {
                console.error('Health check failed:', e);
            }
        }

        function updateHealthDot(id, healthy) {
            const dot = document.getElementById(id);
            dot.className = `health-dot health-${healthy ? 'healthy' : 'unhealthy'}`;
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                const data = await res.json();
                
                document.getElementById('statStudents').textContent = data.total_students.toLocaleString();
                document.getElementById('statTeachers').textContent = data.total_teachers.toLocaleString();
                document.getElementById('statTransactions').textContent = data.transactions_today.toLocaleString();
                document.getElementById('statAttendance').textContent = data.attendance_today.toLocaleString();
            } catch (e) {
                console.error('Stats failed:', e);
            }
        }

        async function loadTrends() {
            try {
                const [txRes, attRes] = await Promise.all([
                    fetch(`${API_BASE}/trends/transactions`),
                    fetch(`${API_BASE}/trends/attendance`)
                ]);
                
                const txData = await txRes.json();
                const attData = await attRes.json();
                
                if (transactionChart) transactionChart.destroy();
                if (attendanceChart) attendanceChart.destroy();
                
                const txCtx = document.getElementById('transactionChart').getContext('2d');
                transactionChart = new Chart(txCtx, {
                    type: 'line',
                    data: {
                        labels: txData.map(d => d.date),
                        datasets: [{
                            label: 'Transactions',
                            data: txData.map(d => d.count),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.08)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#f1f5f9' },
                                ticks: { font: { size: 11 } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 11 } }
                            }
                        }
                    }
                });
                
                const attCtx = document.getElementById('attendanceChart').getContext('2d');
                attendanceChart = new Chart(attCtx, {
                    type: 'line',
                    data: {
                        labels: attData.map(d => d.date),
                        datasets: [{
                            label: 'Attendance',
                            data: attData.map(d => d.count),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.08)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointBackgroundColor: '#8b5cf6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#f1f5f9' },
                                ticks: { font: { size: 11 } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 11 } }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Trends failed:', e);
            }
        }

        async function loadStudents() {
            try {
                const res = await fetch(`${API_BASE}/students`);
                students = await res.json();
                
                const tbody = document.getElementById('studentsTable');
                tbody.innerHTML = students.map(s => `
                    <tr>
                        <td class="font-medium">${s.full_name}</td>
                        <td class="mono text-enterprise-500">${s.phone_number || '—'}</td>
                        <td>${s.program_name || '—'}</td>
                        <td><span class="badge ${s.is_active ? 'badge-success' : 'badge-danger'}">${s.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button onclick="toggleUserStatus('${s.user_id}', ${!s.is_active})" class="action-link action-link-primary">${s.is_active ? 'Deactivate' : 'Activate'}</button>
                            <span class="text-enterprise-300 mx-2">|</span>
                            <button onclick="deleteUser('${s.user_id}')" class="action-link action-link-danger">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Load students failed:', e);
            }
        }

        async function loadTeachers() {
            try {
                const res = await fetch(`${API_BASE}/teachers`);
                teachers = await res.json();
                
                const tbody = document.getElementById('teachersTable');
                tbody.innerHTML = teachers.map(t => `
                    <tr>
                        <td class="font-medium">${t.full_name}</td>
                        <td>${t.program_name || '—'}</td>
                        <td><span class="badge ${t.is_active ? 'badge-success' : 'badge-danger'}">${t.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button onclick="toggleUserStatus('${t.user_id}', ${!t.is_active})" class="action-link action-link-primary">${t.is_active ? 'Deactivate' : 'Activate'}</button>
                            <span class="text-enterprise-300 mx-2">|</span>
                            <button onclick="deleteUser('${t.user_id}')" class="action-link action-link-danger">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Load teachers failed:', e);
            }
        }

        async function loadPrograms() {
            try {
                const res = await fetch(`${API_BASE}/programs`);
                programs = await res.json();
                
                const tbody = document.getElementById('programsTable');
                if (tbody) {
                    tbody.innerHTML = programs.map(p => `
                        <tr>
                            <td class="font-medium">${p.name}</td>
                            <td class="mono text-enterprise-500">${p.cost_center}</td>
                            <td>${p.default_daily_allowance} SAR</td>
                            <td>${p.student_count}</td>
                            <td>${p.teacher_count}</td>
                            <td><span class="badge ${p.is_active ? 'badge-success' : 'badge-danger'}">${p.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button onclick="deleteProgram('${p.program_id}')" class="action-link action-link-danger">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                console.error('Load programs failed:', e);
            }
        }

        function loadProgramSelects() {
            const selects = ['createUserProgram', 'bulkStudentProgram', 'bulkTeacherProgram', 'bulkAllowanceProgram'];
            const options = programs.map(p => `<option value="${p.program_id}">${p.name}</option>`).join('');
            selects.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<option value="">Select Program</option>' + options;
            });
            // Multi-select for teacher programs (no "Select" placeholder needed)
            const multiSelect = document.getElementById('createUserProgramsMulti');
            if (multiSelect) multiSelect.innerHTML = options;
        }

        async function loadStudentSelect() {
            if (students.length === 0) await loadStudents();
            const options = students.map(s => `<option value="${s.student_id}">${s.full_name}</option>`).join('');
            document.getElementById('allowanceStudent').innerHTML = '<option value="">Select Student</option>' + options;
        }

        async function loadAllowances() {
            const date = document.getElementById('allowanceDate').value;
            const userType = document.getElementById('allowanceUserType').value;
            try {
                let url = `${API_BASE}/allowances`;
                const params = [];
                if (date) params.push(`filter_date=${date}`);
                if (userType) params.push(`user_type=${userType}`);
                if (params.length > 0) url += '?' + params.join('&');
                
                const res = await fetch(url);
                const data = await res.json();
                
                const tbody = document.getElementById('allowancesTable');
                tbody.innerHTML = data.map(a => `
                    <tr>
                        <td class="font-medium">${a.full_name}</td>
                        <td><span class="badge ${a.user_type === 'teacher' ? 'badge-info' : 'badge-primary'}">${a.user_type === 'teacher' ? 'Teacher' : 'Student'}</span></td>
                        <td>${a.date}</td>
                        <td>${a.base_amount} SAR</td>
                        <td>${a.bonus_amount} SAR</td>
                        <td class="font-semibold text-enterprise-900">${a.total_amount} SAR</td>
                    </tr>
                `).join('') || '<tr><td colspan="6" class="text-center text-enterprise-500 py-8">No allowances found for the selected criteria</td></tr>';
            } catch (e) {
                showToast('Failed to load allowances', 'error');
            }
        }

        async function loadTelemetry() {
            try {
                const res = await fetch(`${API_BASE}/telemetry`);
                const data = await res.json();
                
                // PostgreSQL - wide layout with tables in grid
                const tableEntries = Object.entries(data.postgres.table_counts);
                document.getElementById('pgTelemetry').innerHTML = `
                    <div style="padding-right: 24px; border-right: 1px solid #e2e8f0;">
                        <div class="text-enterprise-600 text-xs uppercase tracking-wide mb-3">Database Info</div>
                        <div class="flex justify-between py-2">
                            <span class="text-enterprise-600">Database Size</span>
                            <span class="font-semibold text-enterprise-900">${data.postgres.database_size}</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-enterprise-600">Total Tables</span>
                            <span class="font-semibold text-enterprise-900">${tableEntries.length}</span>
                        </div>
                    </div>
                    <div>
                        <div class="text-enterprise-600 text-xs uppercase tracking-wide mb-3">Table Row Counts</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                            ${tableEntries.map(([k,v]) => `
                                <div style="background: #f8fafc; padding: 12px; border-radius: 8px;">
                                    <div class="text-xs text-enterprise-500 mb-1">${k}</div>
                                    <div class="font-semibold text-enterprise-900">${v} rows</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                document.getElementById('mongoTelemetry').innerHTML = `
                    <div class="flex justify-between py-2 border-b border-enterprise-100">
                        <span class="text-enterprise-600">Total Documents</span>
                        <span class="font-medium text-enterprise-900">${data.mongodb.total_documents}</span>
                    </div>
                    <div class="pt-2">
                        <span class="text-enterprise-600 text-xs uppercase tracking-wide">Collections</span>
                        ${Object.entries(data.mongodb.collections).map(([k,v]) => `
                            <div class="flex justify-between py-1.5 text-enterprise-600">
                                <span>${k}</span>
                                <span class="mono">${v}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                document.getElementById('redisTelemetry').innerHTML = `
                    <div class="flex justify-between py-2 border-b border-enterprise-100">
                        <span class="text-enterprise-600">Memory Usage</span>
                        <span class="font-medium text-enterprise-900">${data.redis.memory}</span>
                    </div>
                    <div class="flex justify-between py-2">
                        <span class="text-enterprise-600">Total Keys</span>
                        <span class="font-medium text-enterprise-900">${data.redis.keys}</span>
                    </div>
                `;
                
                document.getElementById('txTelemetry').innerHTML = `
                    <div class="grid grid-cols-3 gap-4">
                        <div class="telemetry-stat">
                            <div class="value">${data.transactions.today}</div>
                            <div class="label">Today</div>
                        </div>
                        <div class="telemetry-stat">
                            <div class="value">${data.transactions.week}</div>
                            <div class="label">This Week</div>
                        </div>
                        <div class="telemetry-stat">
                            <div class="value">${data.transactions.month}</div>
                            <div class="label">This Month</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('attTelemetry').innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="telemetry-stat">
                            <div class="value">${data.attendance.today}</div>
                            <div class="label">Today</div>
                        </div>
                        <div class="telemetry-stat">
                            <div class="value">${data.attendance.week}</div>
                            <div class="label">This Week</div>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('Telemetry failed:', e);
            }
        }

        function toggleUserFields(role) {
            document.getElementById('studentFields').classList.toggle('hidden', role !== 'student');
            document.getElementById('programSelectContainer').classList.toggle('hidden', role !== 'student');
            document.getElementById('classSelectContainer').classList.toggle('hidden', role !== 'student');
            document.getElementById('teacherProgramsContainer').classList.toggle('hidden', role !== 'teacher');
            document.getElementById('programRequiredStar').style.display = role === 'student' ? 'inline' : 'none';
        }

        async function loadClassesForProgram(programId, targetSelectId) {
            const select = document.getElementById(targetSelectId);
            if (!programId) {
                select.innerHTML = '<option value="">Select a program first</option>';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/classes?program_id=${programId}`);
                const classes = await res.json();
                select.innerHTML = '<option value="">Select Class (optional)</option>' +
                    classes.map(c => `<option value="${c.class_id}">${c.name}${c.teacher_name ? ' (' + c.teacher_name + ')' : ''}</option>`).join('');
            } catch (e) {
                select.innerHTML = '<option value="">Failed to load classes</option>';
            }
        }

        async function loadBulkStudentClasses() {
            const programId = document.getElementById('bulkStudentProgram').value;
            await loadClassesForProgram(programId, 'bulkStudentClass');
        }

        async function updateSupplementTargets() {
            const type = document.getElementById('supplementType').value;
            const targetSelect = document.getElementById('supplementTarget');
            
            if (type === 'student') {
                if (students.length === 0) await loadStudents();
                targetSelect.innerHTML = '<option value="">Select Student</option>' + 
                    students.map(s => `<option value="${s.student_id}">${s.full_name}</option>`).join('');
            } else {
                if (teachers.length === 0) await loadTeachers();
                targetSelect.innerHTML = '<option value="">Select Teacher</option>' + 
                    teachers.map(t => `<option value="${t.teacher_id}">${t.full_name}</option>`).join('');
            }
        }

        async function handleAddSupplement(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            
            try {
                const res = await fetch(`${API_BASE}/supplements`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    showToast(result.message || 'Supplement added successfully!', 'success');
                    e.target.reset();
                    document.getElementById('supplementDate').valueAsDate = new Date();
                } else {
                    showToast(result.detail || 'Failed to add supplement', 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function handleCreateUser(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form));
            
            // For teachers, get selected program IDs from multi-select
            if (data.role === 'teacher') {
                const multiSelect = document.getElementById('createUserProgramsMulti');
                const selectedPrograms = Array.from(multiSelect.selectedOptions).map(opt => opt.value);
                data.program_ids = selectedPrograms;
                delete data.program_id; // Teachers use program_ids instead
            }
            
            try {
                const res = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    showToast('User created successfully!', 'success');
                    form.reset();
                    toggleUserFields('student'); // Reset visibility to default
                    loadStudents();
                    loadTeachers();
                } else {
                    showToast(result.detail || 'Failed to create user', 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function toggleUserStatus(userId, isActive) {
            try {
                const res = await fetch(`${API_BASE}/users/${userId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: isActive })
                });
                if (res.ok) {
                    showToast('Status updated successfully', 'success');
                    loadStudents();
                    loadTeachers();
                }
            } catch (e) {
                showToast('Failed to update status', 'error');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
            try {
                const res = await fetch(`${API_BASE}/users/${userId}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('User deleted successfully', 'success');
                    loadStudents();
                    loadTeachers();
                }
            } catch (e) {
                showToast('Failed to delete user', 'error');
            }
        }

        async function handleBulkStudents(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            try {
                const res = await fetch(`${API_BASE}/bulk/students`, { method: 'POST', body: formData });
                const result = await res.json();
                
                document.getElementById('bulkStudentResult').innerHTML = `
                    <div class="info-box ${result.errors?.length > 0 ? 'info-box-warning' : 'info-box-success'}">
                        <i class="fa-solid fa-circle-check" style="margin-top: 2px;"></i>
                        <span>Successfully created ${result.created} students
                        ${result.errors?.length > 0 ? `<br><span style="color: #92400e; margin-top: 4px; display: block;"><i class="fa-solid fa-triangle-exclamation"></i> ${result.errors.length} errors occurred</span>` : ''}</span>
                    </div>
                `;
                loadStudents();
            } catch (e) {
                document.getElementById('bulkStudentResult').innerHTML = `<div class="info-box info-box-warning"><i class="fa-solid fa-circle-xmark" style="margin-top: 2px;"></i> <span>Error: ${e.message}</span></div>`;
            }
        }

        async function handleBulkTeachers(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            try {
                const res = await fetch(`${API_BASE}/bulk/teachers`, { method: 'POST', body: formData });
                const result = await res.json();
                
                document.getElementById('bulkTeacherResult').innerHTML = `
                    <div class="info-box ${result.errors?.length > 0 ? 'info-box-warning' : 'info-box-success'}">
                        <i class="fa-solid fa-circle-check" style="margin-top: 2px;"></i>
                        <span>Successfully created ${result.created} teachers
                        ${result.errors?.length > 0 ? `<br><span style="color: #92400e; margin-top: 4px; display: block;"><i class="fa-solid fa-triangle-exclamation"></i> ${result.errors.length} errors occurred</span>` : ''}</span>
                    </div>
                `;
                loadTeachers();
            } catch (e) {
                document.getElementById('bulkTeacherResult').innerHTML = `<div class="info-box info-box-warning"><i class="fa-solid fa-circle-xmark" style="margin-top: 2px;"></i> <span>Error: ${e.message}</span></div>`;
            }
        }

        async function handleSetAllowance(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            
            try {
                const res = await fetch(`${API_BASE}/allowances`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showToast('Allowance set successfully!', 'success');
                    e.target.reset();
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function handleBulkAllowance(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            
            try {
                const res = await fetch(`${API_BASE}/allowances/bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    showToast(`Allowances set for ${result.count} students!`, 'success');
                    e.target.reset();
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function handleCreateProgram(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            
            try {
                const res = await fetch(`${API_BASE}/programs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showToast('Program created successfully!', 'success');
                    e.target.reset();
                    loadPrograms();
                    loadProgramSelects();
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function deleteProgram(programId) {
            if (!confirm('Are you sure you want to delete this program? This action cannot be undone.')) return;
            try {
                const res = await fetch(`${API_BASE}/programs/${programId}`, { method: 'DELETE' });
                const result = await res.json();
                if (res.ok) {
                    showToast('Program deleted successfully', 'success');
                    loadPrograms();
                } else {
                    showToast(result.detail || 'Cannot delete program', 'error');
                }
            } catch (e) {
                showToast('Failed to delete program', 'error');
            }
        }

        // ===== CLASS MANAGEMENT =====
        let classes = [];
        
        async function loadClasses() {
            try {
                const filterProgram = document.getElementById('classFilterProgram').value;
                let url = `${API_BASE}/classes`;
                if (filterProgram) url += `?program_id=${filterProgram}`;
                
                const res = await fetch(url);
                classes = await res.json();
                
                const tbody = document.getElementById('classesTable');
                tbody.innerHTML = classes.map(c => `
                    <tr>
                        <td class="font-medium">${c.name}</td>
                        <td>${c.program_name || 'N/A'}</td>
                        <td>${c.teacher_name || 'Unassigned'}</td>
                        <td><span class="badge ${c.active ? 'badge-success' : 'badge-danger'}">${c.active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button onclick="deleteClass('${c.class_id}')" class="action-link action-link-danger">Delete</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="text-center text-enterprise-500 py-8">No classes found</td></tr>';
            } catch (e) {
                console.error('Load classes failed:', e);
            }
        }

        function loadClassFormSelects() {
            // Populate program dropdown for class form
            const programOptions = programs.map(p => `<option value="${p.program_id}">${p.name}</option>`).join('');
            document.getElementById('classFormProgram').innerHTML = '<option value="">Select Program</option>' + programOptions;
            document.getElementById('classFilterProgram').innerHTML = '<option value="">All Programs</option>' + programOptions;
            
            // Populate teacher dropdown for class form
            const teacherOptions = teachers.map(t => `<option value="${t.user_id}">${t.full_name}</option>`).join('');
            document.getElementById('classFormTeacher').innerHTML = '<option value="">Select Teacher</option>' + teacherOptions;
        }

        async function handleCreateClass(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            
            try {
                const res = await fetch(`${API_BASE}/classes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (res.ok) {
                    showToast('Class created successfully!', 'success');
                    e.target.reset();
                    loadClasses();
                } else {
                    showToast(result.detail || 'Failed to create class', 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function deleteClass(classId) {
            if (!confirm('Are you sure you want to delete this class?')) return;
            try {
                const res = await fetch(`${API_BASE}/classes/${classId}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('Class deleted successfully', 'success');
                    loadClasses();
                } else {
                    const result = await res.json();
                    showToast(result.detail || 'Cannot delete class', 'error');
                }
            } catch (e) {
                showToast('Failed to delete class', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const bgColors = {
                success: '#059669',
                error: '#dc2626',
                info: '#2563eb'
            };
            
            const icons = {
                success: 'fa-circle-check',
                error: 'fa-circle-xmark',
                info: 'fa-circle-info'
            };
            
            toast.className = 'toast';
            toast.style.cssText = `background: ${bgColors[type] || bgColors.info}; color: #fff; padding: 14px 20px; border-radius: 10px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.25); display: flex; align-items: center; gap: 12px; min-width: 300px;`;
            toast.innerHTML = `
                <i class="fa-solid ${icons[type] || icons.info}" style="font-size: 18px;"></i>
                <span style="font-size: 14px; font-weight: 500;">${message}</span>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
    </script>
</body>
</html>